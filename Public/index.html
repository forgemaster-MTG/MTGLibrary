<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>MTG Forge - Deck & Collection Manager</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap"
      rel="stylesheet"
    />
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="stylesheet" href="styles.css">
    <!-- Tiny transparent favicon to avoid 404 in headless tests -->
    <link rel="icon" href="MTG-Forge_Logo_No_Background.png">
    <!-- Legacy inline first-run proxy removed: modular handler in Public/js/main/app.js (window.handleFirstRunSetup) is used instead -->
  </head>
  <body class="bg-gray-900 text-gray-200">
    <!-- Login Screen -->
    <div
      id="login-screen"
      class="fixed inset-0 z-[100] flex items-center justify-center"
      style="background-image: url('MTG-Forge_Logo_Background.png'); background-size: 100% 100%; background-position: center; background-repeat: no-repeat;"
    >
      <div class="p-8 bg-black/40 backdrop-blur-md rounded-lg shadow-2xl max-w-sm w-full border border-white/10">
        <form id="email-login-form" class="space-y-4">
          <div>
            <label
              for="email"
              class="block text-sm font-medium text-left text-gray-300"
              >Email</label
            >
            <input
              type="email"
              id="email"
              required
              class="mt-1 w-full p-2 border rounded-md bg-gray-700 border-gray-600 text-white"
            />
          </div>
          <div>
            <label
              for="password"
              class="block text-sm font-medium text-left text-gray-300"
              >Password</label
            >
            <input
              type="password"
              id="password"
              required
              class="mt-1 w-full p-2 border rounded-md bg-gray-700 border-gray-600 text-white"
            />
          </div>
          <div class="flex space-x-2">
            <button
              type="button"
              id="email-login-btn"
              class="w-full bg-indigo-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-indigo-700 transition"
            >
              Login
            </button>
            <button
              type="button"
              id="signup-btn"
              class="w-full bg-gray-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-gray-500 transition"
            >
              Sign Up
            </button>
          </div>
        </form>
        <div class="relative flex py-5 items-center">
          <div class="flex-grow border-t border-gray-600"></div>
          <span class="flex-shrink mx-4 text-gray-500">Or</span>
          <div class="flex-grow border-t border-gray-600"></div>
        </div>
        <button
          id="login-with-google-btn"
          class="w-full flex items-center justify-center bg-gray-200 border border-gray-400 text-gray-800 font-bold py-3 px-4 rounded-lg hover:bg-gray-300 transition"
        >
          <svg
            class="w-5 h-5 mr-3"
            viewBox="0 0 48 48"
            fill="none"
            xmlns="http://www.w3.org/2000/svg"
          >
            <path
              fill-rule="evenodd"
              clip-rule="evenodd"
              d="M48 24C48 22.0435 47.2107 20.1692 45.8284 18.7869C44.4461 17.4046 42.5717 16.6152 40.6154 16.6152H24V29.5385H37.8462C37.4308 32.6154 35.8462 35.2615 33.2308 36.9231V43.8462H41.6923C45.5077 40.2462 48 34.8 48 24Z"
              fill="#4285F4"
            ></path>
            <path
              fill-rule="evenodd"
              clip-rule="evenodd"
              d="M24 48C30.6 48 36.2769 45.8769 40.6154 42.1846L33.2308 36.9231C31.1077 38.3077 28.1538 39.2308 24 39.2308C17.6308 39.2308 12.1846 34.9846 10.3385 29.2615H1.56923V36.4615C5.90769 43.4769 14.3077 48 24 48Z"
              fill="#34A853"
            ></path>
            <path
              fill-rule="evenodd"
              clip-rule="evenodd"
              d="M10.3385 29.2615C9.87692 27.8769 9.6 26.3077 9.6 24.5538C9.6 22.8 9.87692 21.2308 10.3385 19.8462V12.6462H1.56923C-0.553846 16.7077 -0.553846 21.8462 1.56923 35.9077L10.3385 29.2615Z"
              fill="#FBBC05"
            ></path>
            <path
              fill-rule="evenodd"
              clip-rule="evenodd"
              d="M24 9.87692C27.3231 9.87692 30.0923 11 32.3077 12.9231L39.8769 5.35385C35.6308 1.84615 30.0923 0 24 0C14.3077 0 5.90769 4.52308 1.56923 11.5385L10.3385 18.2308C12.1846 12.5077 17.6308 9.87692 24 9.87692Z"
              fill="#EA4335"
            ></path>
          </svg>
          Sign in with Google
        </button>
      </div>
    </div>

    <!-- Main Application Container -->
    <div id="app-wrapper" class="hidden w-full h-screen flex relative">
      <!-- Mobile Header (visible only on small screens) -->
      <div id="mobile-header" class="md:hidden fixed top-0 left-0 right-0 bg-gray-800 border-b border-gray-700 z-40 flex items-center justify-between px-4 py-3">
        <button id="mobile-menu-toggle" class="text-white p-2 hover:bg-gray-700 rounded-lg transition-colors">
          <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path>
          </svg>
        </button>
        <h1 class="text-lg font-bold bg-gradient-to-r from-purple-400 to-pink-600 bg-clip-text text-transparent">
          MTG Forge
        </h1>
        <div class="w-10"></div> <!-- Spacer for centering -->
      </div>

      <!-- Mobile Backdrop -->
      <div id="mobile-backdrop" class="fixed inset-0 bg-black/50 z-40 hidden md:hidden"></div>

      <!-- Sidebar Navigation -->
      <nav id="sidebar" class="
        fixed md:static
        w-64 
        bg-gray-800 
        flex-shrink-0 
        flex flex-col 
        p-4
        h-full
        transition-transform duration-300 ease-in-out
        -translate-x-full md:translate-x-0
        z-50
        md:z-auto
      ">
        <div class="flex items-center justify-center mb-8">
          <img src="MTG-Forge_Logo_No_Background.png" alt="MTG Forge" class="h-32 w-auto transition-transform hover:scale-105">
        </div>
        <div class="space-y-2 flex-grow">
          <button
            id="nav-collection"
            class="nav-link w-full text-left flex items-center gap-3 px-3 py-2 rounded-lg bg-indigo-600 text-white"
          >
            <svg
              class="w-5 h-5"
              fill="none"
              stroke="currentColor"
              viewBox="0 0 24 24"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10"
              ></path>
            </svg>
            My Collection
          </button>
          <button
            id="nav-decks"
            class="nav-link w-full text-left flex items-center gap-3 px-3 py-2 rounded-lg text-gray-400 hover:bg-gray-700 hover:text-white"
          >
            <svg
              class="w-5 h-5"
              fill="none"
              stroke="currentColor"
              viewBox="0 0 24 24"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M3 7v10a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-6l-2-2H5a2 2 0 00-2 2z"
              ></path>
            </svg>
            Decks
          </button>
          <button
            id="nav-sets"
            class="nav-link w-full text-left flex items-center gap-3 px-3 py-2 rounded-lg text-gray-400 hover:bg-gray-700 hover:text-white"
          >
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 7h18M3 12h18M3 17h18" />
            </svg>
            Sets
          </button>
          <!-- <button
            id="nav-precons"
            class="nav-link w-full text-left flex items-center gap-3 px-3 py-2 rounded-lg text-gray-400 hover:bg-gray-700 hover:text-white"
          >
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h7" />
            </svg>
            <span class="flex items-center gap-2">
              <span>Precons</span>
              <span class="ml-2 text-xs text-yellow-300 bg-yellow-900/20 px-2 py-0.5 rounded-md hidden sm:inline">Under construction</span>
            </span>
          </button> -->
          <div class="border-t border-gray-700 my-4"></div>
          <button
            id="nav-rule-lookup"
            class="nav-link w-full text-left flex items-center gap-3 px-3 py-2 rounded-lg text-gray-400 hover:bg-gray-700 hover:text-white"
          >
            <svg
              class="w-5 h-5"
              fill="none"
              stroke="currentColor"
              viewBox="0 0 24 24"
              xmlns="http://www.w3.org/2000/svg"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M8.228 9c.549-1.165 2.03-2 3.772-2 2.21 0 4 1.79 4 4s-1.79 4-4 4c-1.742 0-3.223-.835-3.772-2M12 5v.01M12 19v.01"
              ></path>
            </svg>
            Rule Lookup
          </button>
          <button
            id="nav-general-chat"
            class="nav-link w-full text-left flex items-center gap-3 px-3 py-2 rounded-lg text-gray-400 hover:bg-gray-700 hover:text-white"
          >
            <svg
              class="w-5 h-5"
              fill="none"
              stroke="currentColor"
              viewBox="0 0 24 24"
              xmlns="http://www.w3.org/2000/svg"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"
              ></path>
            </svg>
            MTG Chat
          </button>
        </div>
        <div class="space-y-2">
          <button
            id="nav-settings"
            class="nav-link w-full text-left flex items-center gap-3 px-3 py-2 rounded-lg text-gray-400 hover:bg-gray-700 hover:text-white"
          >
            <svg
              class="w-5 h-5"
              fill="none"
              stroke="currentColor"
              viewBox="0 0 24 24"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"
              ></path>
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"
              ></path>
            </svg>
            Settings
          </button>
        </div>
      </nav>

      <!-- Main Content -->
      <div
        id="app-content"
        class="flex-1 flex flex-col h-screen overflow-y-auto pt-16 md:pt-0"
      >
        <header
          class="bg-gray-800/80 backdrop-blur-sm sticky top-0 z-10 p-4 flex justify-between items-center border-b border-gray-700"
        >
          <h2 id="page-title" class="text-2xl font-bold">My Collection</h2>
          <div class="flex items-center gap-4">
              <!-- How to Start / Guided Help Button -->
              <button
                id="how-to-start-btn"
                title="How to Start"
                class="bg-teal-600 hover:bg-teal-700 text-white font-medium py-2 px-3 rounded-lg transition duration-200 flex items-center gap-2"
              >
                <svg class="w-5 h-5" viewBox="0 0 24 24" fill="none" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M12 20c4.418 0 8-3.582 8-8s-3.582-8-8-8-8 3.582-8 8 3.582 8 8 8z"/></svg>
                <span class="hidden sm:inline">How to Start</span>
              </button>
            <button
              id="new-player-guide-btn"
              class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg transition duration-300 flex items-center gap-2"
            >
              <svg
                class="w-5 h-5"
                fill="none"
                stroke="currentColor"
                viewBox="0 0 24 24"
                xmlns="http://www.w3.org/2000/svg"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M8.228 9c.549-1.165 2.03-2 3.772-2 2.21 0 4 1.79 4 4s-1.79 4-4 4c-1.742 0-3.223-.835-3.772-2M12 5v.01M12 19v.01"
                ></path>
              </svg>
              New Player Guide
            </button>
            <button
              id="open-playstyle-panel-btn"
              title="Playstyle"
              class="bg-gray-700 hover:bg-gray-600 text-white font-medium py-2 px-3 rounded-lg transition duration-200 flex items-center gap-2"
            >
              <svg class="w-5 h-5" viewBox="0 0 24 24" fill="none" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 20l9-5-9-5-9 5 9 5z"/></svg>
              <span class="hidden sm:inline">Playstyle</span>
            </button>
            <button
              id="edit-mode-toggle"
              class="bg-yellow-600 hover:bg-yellow-700 text-white font-bold py-2 px-4 rounded-lg transition duration-300 flex items-center gap-2"
            >
              <svg
                class="w-5 h-5"
                fill="none"
                stroke="currentColor"
                viewBox="0 0 24 24"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z"
                ></path>
              </svg>
              <span id="edit-mode-text">Edit Mode</span>
            </button>
          </div>
        </header>

        <main id="main-content" class="p-6 space-y-6">
          <!-- Collection View -->
          <!-- Collection View -->
          <div id="collection-view" class="space-y-6">
            
            <!-- Top Section: KPIs & Add Card -->
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
              
              <!-- KPI Cards (Spans 2 columns on large screens) -->
              <div id="collection-kpi-bar" class="lg:col-span-2 grid grid-cols-1 sm:grid-cols-3 gap-4">
                <!-- Total Cards -->
                <div class="bg-gray-800 rounded-xl p-4 border border-gray-700 shadow-sm flex flex-col items-center justify-center relative overflow-hidden group">
                  <div class="absolute inset-0 bg-gradient-to-br from-indigo-500/10 to-transparent opacity-0 group-hover:opacity-100 transition-opacity"></div>
                  <span class="text-sm text-gray-400 font-medium z-10">Total Cards</span>
                  <span id="kpi-total-cards" data-metric="total_cards" class="text-3xl font-bold text-white mt-1 z-10">0</span>
                  <span class="text-xs text-gray-500 z-10">All copies</span>
                </div>

                <!-- Unique Cards -->
                <div class="bg-gray-800 rounded-xl p-4 border border-gray-700 shadow-sm flex flex-col items-center justify-center relative overflow-hidden group">
                  <div class="absolute inset-0 bg-gradient-to-br from-pink-500/10 to-transparent opacity-0 group-hover:opacity-100 transition-opacity"></div>
                  <span class="text-sm text-gray-400 font-medium z-10">Unique Cards</span>
                  <span id="kpi-unique-cards" data-metric="unique_cards" class="text-3xl font-bold text-white mt-1 z-10">0</span>
                  <span class="text-xs text-gray-500 z-10">Distinct names</span>
                </div>

                <!-- Total Price -->
                <div class="bg-gray-800 rounded-xl p-4 border border-gray-700 shadow-sm flex flex-col items-center justify-center relative overflow-hidden group">
                  <div class="absolute inset-0 bg-gradient-to-br from-green-500/10 to-transparent opacity-0 group-hover:opacity-100 transition-opacity"></div>
                  <span class="text-sm text-gray-400 font-medium z-10">Total Value</span>
                  <span id="kpi-total-price" data-metric="total_price" class="text-3xl font-bold text-green-400 mt-1 z-10">$0.00</span>
                  <span class="text-xs text-gray-500 z-10">Market Price (USD)</span>
                </div>
              </div>

              <!-- Add Card Section (Spans 1 column) -->
              <div class="bg-gray-800 rounded-xl p-4 border border-gray-700 shadow-sm flex flex-col justify-center">
                <label for="card-search-input" class="text-sm font-semibold text-gray-300 mb-2 flex items-center gap-2">
                  <svg class="w-4 h-4 text-indigo-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/></svg>
                  Add to Collection
                </label>
                <div class="relative flex gap-2">
                  <input
                    type="text"
                    id="card-search-input"
                    class="w-full bg-gray-900 border border-gray-600 rounded-lg pl-3 pr-10 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-transparent transition-all"
                    placeholder="Card name..."
                  />
                  <button
                    id="search-card-btn"
                    class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold p-2 rounded-lg transition-colors flex-shrink-0"
                    title="Search"
                  >
                    <svg id="search-icon" class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/></svg>
                    <div id="search-spinner" class="hidden animate-spin rounded-full h-5 w-5 border-b-2 border-white"></div>
                  </button>
                </div>
              </div>
            </div>

            <!-- Controls Bar: Search, Filter, Sort, View -->
            <div class="bg-gray-800 rounded-xl p-4 border border-gray-700 shadow-sm flex flex-col xl:flex-row gap-4 items-center justify-between">
              
              <!-- Left: Search & Filter -->
              <div class="flex flex-col sm:flex-row gap-3 w-full xl:w-auto flex-grow">
                <!-- Quick Filter -->
                <div class="relative flex-grow max-w-md">
                  <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                    <svg class="h-4 w-4 text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 4a1 1 0 011-1h16a1 1 0 011 1v16a1 1 0 01-1 1H4a1 1 0 01-1-1V4zm4 4h8v8H7V8z"/></svg>
                  </div>
                  <input
                    type="text"
                    id="filter-text"
                    class="w-full bg-gray-900 border border-gray-600 rounded-lg pl-10 pr-4 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-transparent"
                    placeholder="Filter collection..."
                  />
                </div>

                <!-- Group By -->
                <div class="flex gap-2">
                  <select
                    id="collection-group-by-1"
                    class="bg-gray-900 border border-gray-600 rounded-lg px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-indigo-500"
                    title="Group By"
                  >
                    <option value="">No Grouping</option>
                    <option value="type_line">Type</option>
                    <option value="rarity">Rarity</option>
                    <option value="color_identity">Color</option>
                    <option value="cmc">Mana Value</option>
                    <option value="set_name">Set</option>
                    <option value="deck">Deck</option>
                  </select>
                  <!-- Secondary Group By (Hidden by default or small) -->
                  <select
                    id="collection-group-by-2"
                    class="hidden sm:block bg-gray-900 border border-gray-600 rounded-lg px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-indigo-500"
                    title="Then By"
                  >
                    <option value="">Then By...</option>
                    <option value="type_line">Type</option>
                    <option value="rarity">Rarity</option>
                    <option value="color_identity">Color</option>
                    <option value="cmc">Mana Value</option>
                    <option value="set_name">Set</option>
                    <option value="deck">Deck</option>
                  </select>
                </div>
              </div>

              <!-- Right: View Options & Actions -->
              <div class="flex flex-wrap items-center gap-3 w-full xl:w-auto justify-end">
                
                <!-- Saved Views -->
                 <div class="flex items-center gap-2">
                  <select id="saved-views-select" class="bg-gray-900 border border-gray-600 rounded-lg px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-indigo-500 max-w-[120px]">
                    <option value="">Views</option>
                  </select>
                </div>

                <div class="h-6 w-px bg-gray-700 mx-1 hidden sm:block"></div>

                <!-- Hide in Decks -->
                 <label class="flex items-center gap-2 cursor-pointer select-none">
                  <input type="checkbox" id="hide-in-deck-checkbox" class="form-checkbox h-4 w-4 text-indigo-600 rounded bg-gray-900 border-gray-600 focus:ring-indigo-500">
                  <span class="text-xs text-gray-400 whitespace-nowrap">Hide Decks</span>
                </label>

                <div class="h-6 w-px bg-gray-700 mx-1 hidden sm:block"></div>

                <!-- Grid Size -->
                <div class="flex bg-gray-900 rounded-lg p-1 border border-gray-600">
                  <button class="grid-size-btn px-2 py-1 rounded text-xs font-medium text-gray-400 hover:text-white transition-colors" data-size="sm">S</button>
                  <button class="grid-size-btn px-2 py-1 rounded text-xs font-medium bg-gray-700 text-white shadow-sm transition-colors" data-size="md">M</button>
                  <button class="grid-size-btn px-2 py-1 rounded text-xs font-medium text-gray-400 hover:text-white transition-colors" data-size="lg">L</button>
                </div>

                <!-- View Toggle -->
                <div class="flex bg-gray-900 rounded-lg p-1 border border-gray-600">
                  <button id="view-toggle-grid" class="view-toggle p-1.5 rounded text-gray-400 hover:text-white transition-colors bg-gray-700 text-white shadow-sm" title="Grid">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2V6zM14 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2V6zM4 16a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2v-2zM14 16a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2v-2z"></path></svg>
                  </button>
                  <button id="view-toggle-table" class="view-toggle p-1.5 rounded text-gray-400 hover:text-white transition-colors" title="Table">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 10h16M4 14h16M4 18h16"></path></svg>
                  </button>
                </div>

                 <!-- Refresh Prices -->
                <button id="refresh-prices-btn" class="text-gray-400 hover:text-green-400 transition-colors p-2" title="Refresh Prices">
                   <svg class="w-5 h-5" viewBox="0 0 24 24" fill="none" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path></svg>
                </button>
                 <button id="reset-filters-btn" class="text-gray-400 hover:text-white transition-colors text-sm font-medium underline decoration-gray-600 hover:decoration-white">Reset</button>
              </div>
            </div>

            <!-- Filtered Count (Subtle) -->
            <div class="flex justify-between items-center px-2">
               <span id="kpi-filtered-summary" data-metric="filtered_summary" class="text-xs text-gray-500 font-mono">Showing all cards</span>
            </div>

            <!-- Collection Content -->
            <div id="collection-content">
              <!-- Grouped or Table content will be injected here -->
            </div>
            <div
              id="collection-pagination"
              class="flex justify-center items-center space-x-2 mt-6"
            >
              <!-- Pagination controls will be injected here -->
            </div>
            <p id="no-cards-msg" class="text-center text-gray-500 mt-8">
              Your collection is empty. Use the search bar above to add cards!
            </p>
          </div>

          <!-- Decks View -->
          <div id="decks-view" class="hidden space-y-6">
            <!-- Decks Header -->
            <div class="flex flex-col md:flex-row justify-between items-end md:items-center gap-4 border-b border-gray-700 pb-4">
              <div>
                <h2 class="text-3xl font-bold text-white">My Decks</h2>
                <p class="text-gray-400 text-sm mt-1">Manage your constructed decks and commander lists.</p>
              </div>
              <button
                id="create-deck-btn"
                class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-6 rounded-lg shadow-lg shadow-indigo-500/20 transition-all transform hover:-translate-y-0.5 flex items-center gap-2"
              >
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/></svg>
                Create New Deck
              </button>
            </div>

            <!-- Decks Grid -->
            <div
              id="decks-list"
              class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6"
            >
              <!-- Deck items will be dynamically inserted here -->
            </div>
            
            <!-- Empty State (Hidden by default) -->
            <div id="no-decks-msg" class="hidden flex flex-col items-center justify-center py-12 text-center">
              <div class="bg-gray-800 p-6 rounded-full mb-4">
                <svg class="w-12 h-12 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10"></path></svg>
              </div>
              <h3 class="text-xl font-bold text-gray-300 mb-2">No Decks Found</h3>
              <p class="text-gray-500 max-w-md mx-auto mb-6">You haven't created any decks yet. Start building your first deck to track your collection and strategies.</p>
              <button
                onclick="document.getElementById('create-deck-btn').click()"
                class="text-indigo-400 hover:text-indigo-300 font-semibold hover:underline"
              >
                Create your first deck
              </button>
            </div>
          </div>

          <!-- Sets View -->
          <div id="sets-view" class="hidden">
            <div class="bg-gray-800 p-4 rounded-lg shadow-lg mb-6 flex flex-col md:flex-row justify-between items-center gap-4">
              <h2 class="text-2xl font-semibold">Sets</h2>
              <div class="flex items-center gap-2">
                <input id="sets-search-input" type="text" placeholder="Filter sets by name or code..." class="bg-gray-700 border border-gray-600 rounded-xl px-4 py-2 text-base focus:outline-none focus:ring-2 focus:ring-indigo-500" />
                <button id="refresh-sets-btn" class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-4 rounded-lg">Refresh</button>
              </div>
            </div>
            <!-- Sets Filters / Display Controls (reusable pattern from Collection) -->
            <div id="sets-filters-bar" class="bg-gray-900 p-4 flex flex-col sm:flex-row gap-4 items-center rounded-b-2xl">
              <div class="flex-grow min-w-[180px] flex flex-col gap-2">
                <label for="sets-filter-text" class="text-sm text-gray-400">Quick Filter</label>
                <div class="flex gap-2">
                  <input
                    type="text"
                    id="sets-filter-text"
                    class="w-full bg-gray-800 border border-gray-700 rounded-xl px-4 py-2 text-base focus:outline-none focus:ring-2 focus:ring-indigo-500 placeholder-gray-400"
                    placeholder="e.g., Zendikar, ZNR..."
                  />
                  <label class="flex items-center gap-2 cursor-pointer select-none bg-gray-800 px-3 py-2 rounded-xl border border-gray-700 hover:border-gray-600 transition-colors whitespace-nowrap" title="Show only sets you have cards from">
                    <input type="checkbox" id="sets-filter-owned-only" class="form-checkbox h-4 w-4 text-indigo-600 rounded bg-gray-700 border-gray-600 focus:ring-indigo-500">
                    <span class="text-sm text-gray-300">Owned Only</span>
                  </label>
                </div>
              </div>

              <div class="flex items-center gap-2">
                <label class="text-sm text-gray-400 mr-2">Grid Size</label>
                <div class="mt-1 flex items-center rounded-lg bg-gray-700 p-1">
                  <button class="sets-grid-size-btn p-2 rounded-md text-gray-400" data-size="sm" title="Small">S</button>
                  <button class="sets-grid-size-btn p-2 rounded-md bg-indigo-600 text-white" data-size="md" title="Medium">M</button>
                  <button class="sets-grid-size-btn p-2 rounded-md text-gray-400" data-size="lg" title="Large">L</button>
                </div>
              </div>

              <div class="flex items-center gap-2">
                <label class="text-sm text-gray-400 mr-2">View</label>
                <div class="mt-1 flex items-center rounded-lg bg-gray-700 p-1">
                  <button id="sets-view-toggle-grid" class="view-toggle p-2 rounded-md bg-indigo-600 text-white" title="Grid View">
                    <svg class="w-4 h-4" viewBox="0 0 24 24" fill="none" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 3h7v7H3zM14 3h7v7h-7zM14 14h7v7h-7zM3 14h7v7H3z"></path></svg>
                  </button>
                  <button id="sets-view-toggle-table" class="view-toggle p-2 rounded-md text-gray-400" title="Table View">
                    <svg class="w-4 h-4" viewBox="0 0 24 24" fill="none" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 10h16M4 14h16M4 18h16"></path></svg>
                  </button>
                </div>
              </div>

              <div class="flex items-center gap-2">
                <label class="text-sm text-gray-400 mr-2">Sort</label>
                <select id="sets-sort-select" class="bg-gray-800 border border-gray-700 rounded-xl px-4 py-2 text-base focus:outline-none focus:ring-2 focus:ring-indigo-500">
                  <option value="name">Name</option>
                  <option value="released">Release Date</option>
                  <option value="card_count">Card Count</option>
                </select>
              </div>

              <button id="sets-reset-filters-btn" class="bg-gray-600 hover:bg-gray-500 text-white font-bold py-2 px-4 rounded-lg">Reset</button>
            </div>
            <div id="sets-content" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-6 gap-4"></div>
            <p id="no-sets-msg" class="text-center text-gray-500 mt-8 hidden">No sets found.</p>
          </div>

          <!-- Set Details View -->
          <div id="set-details-view" class="hidden space-y-6">
            <!-- Header with Back Button, Title, and Stats -->
            <div class="bg-gray-800 p-4 rounded-lg shadow-lg flex flex-col md:flex-row justify-between items-center gap-4">
              <div class="flex items-center gap-4">
                <button id="set-details-back-btn" class="bg-gray-700 hover:bg-gray-600 text-white px-3 py-2 rounded-lg transition-colors flex items-center gap-2">
                  <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"/></svg>
                  Back
                </button>
                <div>
                  <h2 id="set-details-title" class="text-2xl font-bold flex items-center gap-3">Set Name</h2>
                  <p id="set-details-meta" class="text-sm text-gray-400">Released: ... ‚Ä¢ Cards: ...</p>
                </div>
              </div>
              
              <!-- Set Stats / Progress -->
              <div class="flex items-center gap-6 bg-gray-900/50 px-4 py-2 rounded-lg border border-gray-700">
                <div class="text-center">
                  <div class="text-xs text-gray-400 uppercase tracking-wider font-bold">Collected</div>
                  <div id="set-stats-collected" class="text-xl font-bold text-indigo-400">0/0</div>
                </div>
                <div class="w-px h-8 bg-gray-700"></div>
                <div class="text-center">
                  <div class="text-xs text-gray-400 uppercase tracking-wider font-bold">Value</div>
                  <div id="set-stats-value" class="text-xl font-bold text-green-400">$0.00</div>
                </div>
              </div>
            </div>

            <!-- Controls: Tabs & Filters -->
            <div class="bg-gray-800 rounded-xl p-4 border border-gray-700 shadow-sm flex flex-col sm:flex-row gap-4 justify-between items-center">
              <!-- View Tabs -->
              <div class="flex bg-gray-900 rounded-lg p-1 border border-gray-600">
                <button id="set-view-tab-grid" class="px-4 py-2 rounded-md text-sm font-medium bg-indigo-600 text-white shadow-sm transition-all">Grid</button>
                <button id="set-view-tab-table" class="px-4 py-2 rounded-md text-sm font-medium text-gray-400 hover:text-white transition-all">Mass Update Table</button>
              </div>

              <!-- Filters -->
              <div class="flex items-center gap-3">
                <label class="flex items-center gap-2 cursor-pointer select-none bg-gray-900 px-3 py-2 rounded-lg border border-gray-600 hover:border-gray-500 transition-colors">
                  <input type="checkbox" id="set-filter-owned" class="form-checkbox h-4 w-4 text-indigo-600 rounded bg-gray-800 border-gray-600 focus:ring-indigo-500">
                  <span class="text-sm text-gray-300">Owned</span>
                </label>
                <label class="flex items-center gap-2 cursor-pointer select-none bg-gray-900 px-3 py-2 rounded-lg border border-gray-600 hover:border-gray-500 transition-colors">
                  <input type="checkbox" id="set-filter-missing" class="form-checkbox h-4 w-4 text-pink-600 rounded bg-gray-800 border-gray-600 focus:ring-pink-500">
                  <span class="text-sm text-gray-300">Missing</span>
                </label>
                <div class="h-6 w-px bg-gray-700 mx-1"></div>
                <button id="set-add-cards-modal-btn" class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-4 rounded-lg transition-colors flex items-center gap-2 shadow-lg shadow-indigo-500/20">
                  <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/></svg>
                  Add Cards
                </button>
              </div>
            </div>

            <!-- Content Area -->
            <div id="set-details-content" class="min-h-[400px]">
              <!-- Grid or Table injected here -->
            </div>
          </div>

            <!-- Preconstructed Decks (Precons) View -->
            <div id="precons-view" class="hidden">
              <div class="bg-gray-800 p-4 rounded-lg shadow-lg mb-6 flex flex-col md:flex-row justify-between items-center gap-4">
                <h2 class="text-2xl font-semibold">Preconstructed Decks</h2>
                <div class="flex items-center gap-2">
                  <input id="precons-search-input" type="text" placeholder="Filter preconstructed decks by name..." class="bg-gray-700 border border-gray-600 rounded-xl px-4 py-2 text-base focus:outline-none focus:ring-2 focus:ring-indigo-500" />
                  <button id="refresh-precons-btn" class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-4 rounded-lg">Refresh</button>
                </div>
              </div>
              <!-- Banner: Precons under construction -->
              <div id="precons-under-construction" class="mx-0 p-3 mb-4 rounded-lg bg-yellow-900/10 border border-yellow-700 text-yellow-100 flex items-start gap-3">
                <svg class="w-5 h-5 text-yellow-300 mt-0.5" viewBox="0 0 24 24" fill="none" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.29 3.86L1.82 18a2 2 0 001.71 3h16.94a2 2 0 001.71-3L13.71 3.86a2 2 0 00-3.42 0zM12 9v4M12 17h.01"/></svg>
                <div class="text-sm">
                  <strong class="text-yellow-200">Under construction:</strong>
                  <span class="text-yellow-100"> The Preconstructed decks area is experimental and still being built. Features and data may be incomplete ‚Äî proceed for preview only.</span>
                </div>
              </div>
              <div id="precons-filters-bar" class="bg-gray-900 p-4 flex flex-col sm:flex-row gap-4 items-center rounded-b-2xl">
                <div class="flex-grow min-w-[180px]">
                  <label for="precons-filter-text" class="text-sm text-gray-400 mb-2 block">Quick Filter</label>
                  <input
                    type="text"
                    id="precons-filter-text"
                    class="w-full bg-gray-800 border border-gray-700 rounded-xl px-5 py-3 text-base focus:outline-none focus:ring-2 focus:ring-indigo-500 placeholder-gray-400"
                    placeholder="e.g., Commander 2019, Strixhaven..."
                  />
                </div>

                <div class="flex items-center gap-2">
                  <label class="text-sm text-gray-400 mr-2">Grid Size</label>
                  <div class="mt-1 flex items-center rounded-lg bg-gray-700 p-1">
                    <button class="precons-grid-size-btn p-2 rounded-md text-gray-400" data-size="sm" title="Small">S</button>
                    <button class="precons-grid-size-btn p-2 rounded-md bg-indigo-600 text-white" data-size="md" title="Medium">M</button>
                    <button class="precons-grid-size-btn p-2 rounded-md text-gray-400" data-size="lg" title="Large">L</button>
                  </div>
                </div>

                <div class="flex items-center gap-2">
                  <label class="text-sm text-gray-400 mr-2">View</label>
                  <div class="mt-1 flex items-center rounded-lg bg-gray-700 p-1">
                    <button id="precons-view-toggle-grid" class="view-toggle p-2 rounded-md bg-indigo-600 text-white" title="Grid View">Grid</button>
                    <button id="precons-view-toggle-table" class="view-toggle p-2 rounded-md text-gray-400" title="Table View">Table</button>
                  </div>
                </div>

                <button id="precons-reset-filters-btn" class="bg-gray-600 hover:bg-gray-500 text-white font-bold py-2 px-4 rounded-lg">Reset</button>
              </div>
              <div id="precons-content" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-6 gap-4 p-2"></div>
              <p id="no-precons-msg" class="text-center text-gray-500 mt-8 hidden">No preconstructed decks found. Place a precons index at /precons/index.json or add files under Public/precons/.</p>
            </div>

              <!-- Single Precon (per-product) View -->
              <div id="precon-view" class="hidden">
                <div class="bg-gray-800 p-4 rounded-lg shadow-lg mb-6 flex items-center gap-4">
                  <button id="precon-back-btn" class="bg-gray-700 hover:bg-gray-600 text-white px-3 py-2 rounded">Back</button>
            <h2 id="precon-title" class="text-2xl font-semibold flex items-center gap-3">Precon <span class="ml-2 text-xs text-yellow-300 bg-yellow-900/20 px-2 py-0.5 rounded-md">Under construction</span></h2>
                </div>
                <div id="precon-content" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-6 gap-4 p-2"></div>
                <p id="no-precon-msg" class="text-center text-gray-500 mt-8 hidden">Could not load this preconstructed deck.</p>
              </div>

          <!-- Single Deck View -->
          <div id="single-deck-view" class="hidden">
            <!-- Will be populated by JS -->
          </div>

          <!-- Settings View -->
          <div id="settings-view" class="hidden">
            <!-- Tab Navigation -->
            <div class="mb-6">
              <nav class="flex gap-1 border-b-2 border-gray-700 overflow-x-auto" id="settings-tabs-nav">
                <button class="settings-tab px-6 py-3 font-semibold text-gray-400 border-b-4 border-transparent hover:text-white hover:border-gray-600 transition-all whitespace-nowrap flex items-center gap-2" data-tab="general">
                  <span class="text-xl">üè†</span>
                  <span>General</span>
                </button>
                <button class="settings-tab px-6 py-3 font-semibold text-gray-400 border-b-4 border-transparent hover:text-white hover:border-gray-600 transition-all whitespace-nowrap flex items-center gap-2" data-tab="ai">
                  <span class="text-xl">ü§ñ</span>
                  <span>AI & Integrations</span>
                </button>
                <button class="settings-tab px-6 py-3 font-semibold text-gray-400 border-b-4 border-transparent hover:text-white hover:border-gray-600 transition-all whitespace-nowrap flex items-center gap-2" data-tab="display">
                  <span class="text-xl">üëÅÔ∏è</span>
                  <span>Display</span>
                </button>
                <button class="settings-tab px-6 py-3 font-semibold text-gray-400 border-b-4 border-transparent hover:text-white hover:border-gray-600 transition-all whitespace-nowrap flex items-center gap-2" data-tab="data">
                  <span class="text-xl">üíæ</span>
                  <span>Data</span>
                </button>
                <button class="settings-tab px-6 py-3 font-semibold text-gray-400 border-b-4 border-transparent hover:text-white hover:border-gray-600 transition-all whitespace-nowrap flex items-center gap-2" data-tab="views">
                  <span class="text-xl">üìã</span>
                  <span>Saved Views</span>
                </button>
                <button class="settings-tab px-6 py-3 font-semibold text-gray-400 border-b-4 border-transparent hover:text-white hover:border-gray-600 transition-all whitespace-nowrap flex items-center gap-2" data-tab="advanced">
                  <span class="text-xl">‚öôÔ∏è</span>
                  <span>Advanced</span>
                </button>
              </nav>
            </div>

            <!-- Tab Panels -->
            <div class="settings-tab-content">
              <!-- General Tab -->
              <div id="settings-tab-general" class="settings-tab-panel space-y-6">
                <!-- Account Section -->
                <div class="bg-gray-800 p-6 rounded-xl shadow-lg border border-gray-700">
                  <h3 class="text-xl font-bold mb-4 flex items-center gap-2 text-white">
                    <svg class="w-6 h-6 text-indigo-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path>
                    </svg>
                    Account
                  </h3>
                  <div class="space-y-4">
                    <div>
                      <label class="text-sm text-gray-400 font-medium">User Email</label>
                      <p id="user-email" class="text-lg bg-gray-700 p-3 rounded-lg mt-1"></p>
                    </div>
                    <button id="logout-btn" class="bg-red-800 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-lg transition-colors flex items-center gap-2">
                      <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"></path>
                      </svg>
                      Logout
                    </button>
                  </div>
                </div>

                <!-- UI Preferences Section -->
                <div class="bg-gray-800 p-6 rounded-xl shadow-lg border border-gray-700">
                  <h3 class="text-xl font-bold mb-4 flex items-center gap-2 text-white">
                    <svg class="w-6 h-6 text-teal-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6V4m0 2a2 2 0 100 4m0-4a2 2 0 110 4m-6 8a2 2 0 100-4m0 4a2 2 0 110-4m0 4v2m0-6V4m6 6v10m6-2a2 2 0 100-4m0 4a2 2 0 110-4m0 4v2m0-6V4"></path>
                    </svg>
                    UI Preferences
                  </h3>
                  <div id="ui-preferences-container" class="space-y-4">
                    <!-- Will be populated by renderUIPreferences() -->
                  </div>
                </div>
              </div>

              <!-- AI & Integrations Tab -->
              <div id="settings-tab-ai" class="settings-tab-panel hidden space-y-6">
                <div id="settings-gemini-section-container">
                  <!-- Will be populated by renderGeminiSettings() -->
                </div>
              </div>

              <!-- Display Tab -->
              <div id="settings-tab-display" class="settings-tab-panel hidden space-y-6">
                <div class="bg-gray-800 p-6 rounded-xl shadow-lg border border-gray-700">
                  <h3 class="text-xl font-bold mb-4 flex items-center gap-2 text-white">
                    <svg class="w-6 h-6 text-purple-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"></path>
                    </svg>
                    Card Modal Visibility
                  </h3>
                  <p class="text-sm text-gray-400 mb-4">Choose which fields to display when viewing card details</p>
                  <div id="modal-visibility-settings-wrapper" class="space-y-4">
                    <div>
                      <h4 class="text-sm font-semibold text-gray-200 mb-2">Default Options</h4>
                      <div id="modal-visibility-default" class="grid grid-cols-2 gap-3">
                        <!-- Default option checkboxes will be populated here -->
                      </div>
                    </div>
                    <div>
                      <h4 class="text-sm font-semibold text-gray-200 mb-2">Additional Options</h4>
                      <div id="modal-visibility-additional" class="grid grid-cols-2 md:grid-cols-3 gap-3">
                        <!-- Advanced/metadata option checkboxes will be populated here -->
                      </div>
                    </div>
                  </div>
                </div>
              </div>

              <!-- Data Tab -->
              <div id="settings-tab-data" class="settings-tab-panel hidden space-y-6">
                <!-- Import/Export Section -->
                <div class="bg-gray-800 p-6 rounded-xl shadow-lg border border-gray-700">
                  <h3 class="text-xl font-bold mb-4 flex items-center gap-2 text-white">
                    <svg class="w-6 h-6 text-blue-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12"></path>
                    </svg>
                    Import & Export
                  </h3>
                  <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                    <button id="export-all-data-btn" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-4 rounded-lg transition-colors flex items-center justify-center gap-2">
                      <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path></svg>
                      Export All Data
                    </button>
                    <label class="bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-4 rounded-lg cursor-pointer text-center transition-colors flex items-center justify-center gap-2">
                      <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12"></path></svg>
                      Import All Data
                      <input type="file" id="import-all-data-input" class="hidden" accept=".json" />
                    </label>
                    <label class="bg-green-800 hover:bg-green-900 text-white font-bold py-3 px-4 rounded-lg cursor-pointer text-center transition-colors col-span-full sm:col-span-1 flex items-center justify-center gap-2">
                      <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path></svg>
                      Import Deck
                      <input type="file" id="import-deck-data-input" class="hidden" accept=".txt,.json" />
                    </label>
                  </div>
                </div>

                <!-- Deck Management Section -->
                <div class="bg-gray-800 p-6 rounded-xl shadow-lg border border-gray-700">
                  <h3 class="text-xl font-bold mb-4 flex items-center gap-2 text-white">
                    <svg class="w-6 h-6 text-yellow-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10"></path>
                    </svg>
                    Deck Management
                  </h3>
                  <p class="text-gray-400 mb-4">Enable "Edit Mode" from the top bar to delete decks.</p>
                  <div id="settings-deck-list" class="space-y-4">
                    <!-- Deck list will be populated here -->
                  </div>
                </div>

                <!-- Basic Land Inventory Section -->
                <div class="bg-gray-800 p-6 rounded-xl shadow-lg border border-gray-700">
                  <h3 class="text-xl font-bold mb-2 flex items-center gap-2 text-white">
                    <svg class="w-6 h-6 text-green-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 21l18-10L3 1v8l15 2L3 13v8z"></path>
                    </svg>
                    Basic Land Inventory
                  </h3>
                  <p class="text-sm text-gray-400 mb-4">Track your basic lands. These can be freely added to decks without being in your collection.</p>
                  <div id="basic-lands-container">
                    <!-- Basic lands inputs and usage stats will be rendered here -->
                  </div>
                </div>

                <!-- Collection Maintenance Section -->
                <div class="bg-gray-800 p-6 rounded-xl shadow-lg border border-gray-700">
                  <h3 class="text-xl font-bold mb-2 flex items-center gap-2 text-white">
                    <svg class="w-6 h-6 text-yellow-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path>
                    </svg>
                    Collection Maintenance
                  </h3>
                  <p class="text-sm text-gray-400 mb-4">Tools to manage and clean up your collection data.</p>
                  <button onclick="if(window.cleanupCollectionDuplicates) window.cleanupCollectionDuplicates()" class="bg-yellow-600 hover:bg-yellow-500 text-white font-bold py-2 px-4 rounded-lg shadow transition-colors flex items-center gap-2">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg>
                    Cleanup Duplicates
                  </button>
                </div>
              </div>

              <!-- Saved Views Tab -->
              <div id="settings-tab-views" class="settings-tab-panel hidden">
                <div class="bg-gray-800 p-6 rounded-xl shadow-lg border border-gray-700">
                  <h2 class="text-2xl font-semibold mb-4 border-b border-gray-700 pb-2">Saved Views</h2>
                  <div id="settings-saved-views" class="space-y-4">
                    <div id="settings-saved-views-list"></div>
                    <!-- builder panel will appear below when editing/creating -->
                    <div id="view-builder-panel" class="mt-3 hidden bg-gray-900 p-4 rounded">
                      <div id="filters-list" class="space-y-2"></div>
                      <div class="flex gap-2 mt-2">
                        <select id="filter-column-select" class="bg-gray-700 border border-gray-600 rounded-lg px-2 py-1 text-sm">
                          <option value="name">Name</option>
                          <option value="type_line">Type</option>
                          <option value="rarity">Rarity</option>
                          <option value="color_identity">Color Identity</option>
                          <option value="cmc">Mana Value</option>
                          <option value="set_name">Set</option>
                          <option value="count">Count</option>
                          <option value="deck">Deck</option>
                        </select>
                        <select id="filter-op-select" class="bg-gray-700 border border-gray-600 rounded-lg px-2 py-1 text-sm">
                          <option value="contains">contains</option>
                          <option value="equals">equals</option>
                          <option value="gt">&gt;</option>
                          <option value="lt">&lt;</option>
                        </select>
                        <input id="filter-value-input" class="flex-1 bg-gray-700 border border-gray-600 rounded-lg px-2 py-1 text-sm" placeholder="value">
                        <button id="add-filter-rule-btn" class="bg-indigo-600 hover:bg-indigo-700 text-white text-sm font-bold py-1 px-3 rounded">Add</button>
                      </div>
                      <div class="mt-4">
                        <label class="text-sm text-gray-400">Sort Rules (top priority first)</label>
                        <div id="sorts-list" class="space-y-2 mt-2"></div>
                        <div class="flex gap-2 mt-2">
                          <select id="sort-column-select" class="bg-gray-700 border border-gray-600 rounded-lg px-2 py-1 text-sm">
                            <option value="name">Name</option>
                            <option value="count">Count</option>
                            <option value="cmc">Mana Value</option>
                            <option value="rarity">Rarity</option>
                            <option value="price">Price</option>
                          </select>
                          <select id="sort-dir-select" class="bg-gray-700 border border-gray-600 rounded-lg px-2 py-1 text-sm">
                            <option value="asc">asc</option>
                            <option value="desc">desc</option>
                          </select>
                          <button id="add-sort-rule-btn" class="bg-indigo-600 hover:bg-indigo-700 text-white text-sm font-bold py-1 px-3 rounded">Add</button>
                        </div>
                      </div>
                      <div class="mt-4 flex items-center gap-2">
                        <label class="text-sm text-gray-400">Group By</label>
                        <select id="view-group-by-1" class="bg-gray-700 border border-gray-600 rounded-lg px-2 py-1 text-sm">
                          <option value="">None</option>
                          <option value="type_line">Type</option>
                          <option value="rarity">Rarity</option>
                          <option value="color_identity">Color</option>
                          <option value="cmc">Mana Value</option>
                          <option value="set_name">Set</option>
                          <option value="deck">Deck</option>
                        </select>
                        <select id="view-group-by-2" class="bg-gray-700 border border-gray-600 rounded-lg px-2 py-1 text-sm">
                          <option value="">None</option>
                          <option value="type_line">Type</option>
                          <option value="rarity">Rarity</option>
                          <option value="color_identity">Color</option>
                          <option value="cmc">Mana Value</option>
                          <option value="set_name">Set</option>
                          <option value="deck">Deck</option>
                        </select>
                        <label class="text-sm text-gray-400 ml-4">Hide In Decks</label>
                        <input type="checkbox" id="view-hide-in-deck">
                      </div>
                      <div class="mt-4 flex items-center gap-2">
                        <input id="view-name-input" placeholder="View name" class="bg-gray-700 border border-gray-600 rounded-lg px-2 py-1 text-sm">
                        <label class="text-sm text-gray-400 flex items-center gap-2"><input type="checkbox" id="view-default-checkbox"> Set as default</label>
                      </div>
                      <div class="mt-3 flex items-center gap-4">
                        <div>
                          <label class="text-sm text-gray-400 block">View Mode</label>
                          <select id="view-view-mode" class="bg-gray-700 border border-gray-600 rounded-lg px-2 py-1 text-sm">
                            <option value="grid">Grid</option>
                            <option value="table">Table</option>
                          </select>
                        </div>
                        <div>
                          <label class="text-sm text-gray-400 block">Grid Size</label>
                          <select id="view-grid-size" class="bg-gray-700 border border-gray-600 rounded-lg px-2 py-1 text-sm">
                            <option value="sm">Small</option>
                            <option value="md">Medium</option>
                            <option value="lg">Large</option>
                          </select>
                        </div>
                        <div class="flex-1 text-right">
                          <button id="save-view-confirm-btn" class="bg-green-600 hover:bg-green-700 text-white text-sm font-bold py-1 px-3 rounded">Save</button>
                          <button id="cancel-view-builder-btn" class="bg-gray-600 hover:bg-gray-700 text-white text-sm font-bold py-1 px-3 rounded ml-2">Cancel</button>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>

              <!-- Advanced Tab -->
              <div id="settings-tab-advanced" class="settings-tab-panel hidden space-y-6">
                <!-- Precons Admin (injected dynamically for admin users) -->
                <div id="settings-precons-admin-container"></div>
                
                <!-- Danger Zone -->
                <div class="bg-red-900/50 border-2 border-red-700 p-6 rounded-xl shadow-lg">
                  <h3 class="text-2xl font-semibold mb-4 text-red-300 flex items-center gap-2">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path>
                    </svg>
                    Danger Zone
                  </h3>
                  <p class="text-red-200 mb-4">
                    This action is irreversible and will permanently delete your entire collection and all your decks.
                  </p>
                  <button id="clear-data-btn" class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-lg transition-colors">
                    Clear All Account Data
                  </button>
                </div>
              </div>
            </div>
          </div>
          <!-- Playstyle widget removed from embedded Settings view; use header Playstyle button to open floating panel -->
        </main>
      </div>
    </div>

    <!-- Toast Container -->
    <div id="toast-container"></div>

    <!-- Settings Tabs Styles & Script -->
    <style>
      /* Settings Tab Styles */
      .settings-tab {
        position: relative;
        cursor: pointer;
        user-select: none;
      }

      .settings-tab.active {
        color: white !important;
        border-bottom-color: #6366F1 !important; /* indigo-500 */
      }

      .settings-tab:not(.active):hover {
        color: white;
        border-bottom-color: #4B5563; /* gray-600 */
      }

      .settings-tab-panel {
        animation: fadeIn 0.15s ease-in;
      }

      @keyframes fadeIn {
        from {
          opacity: 0;
          transform: translateY(-8px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }
    </style>

    <script>
      // Initialize Settings Tabs
      function initSettingsTabs() {
        const tabs = document.querySelectorAll('.settings-tab');
        const panels = document.querySelectorAll('.settings-tab-panel');
        
        if (!tabs.length || !panels.length) return;
        
        // Set first tab as active by default
        tabs[0]?.classList.add('active');
        
        tabs.forEach((tab, index) => {
          tab.addEventListener('click', () => {
            const targetTab = tab.dataset.tab;
            
            // Remove active from all tabs and hide all panels
            tabs.forEach(t => t.classList.remove('active'));
            panels.forEach(p => p.classList.add('hidden'));
            
            // Activate clicked tab and show corresponding panel
            tab.classList.add('active');
            const targetPanel = document.getElementById(`settings-tab-${targetTab}`);
            if (targetPanel) {
              targetPanel.classList.remove('hidden');
            }
          });
        });
      }
      
    </script>

    <!-- How-To Start Panel (contextual guided start) -->
    <div id="how-to-panel" class="fixed top-16 right-6 z-[80] hidden w-[32rem] max-w-[95vw] bg-transparent">
      <style>
        /* How-To panel animations and highlight styles */
        @keyframes mtg-fade-slide-in { from { opacity: 0; transform: translateY(-6px) scale(0.995); } to { opacity: 1; transform: translateY(0) scale(1); } }
        .howto-enter { animation: mtg-fade-slide-in 240ms cubic-bezier(.2,.9,.2,1) both; }
        .howto-active-step { box-shadow: 0 0 0 4px rgba(16,185,129,0.06), 0 6px 18px rgba(2,6,23,0.6); border-color: rgba(16,185,129,0.9); }
        .howto-pulse { animation: mtg-pulse 1.6s infinite; }
        @keyframes mtg-pulse { 0% { transform: scale(1); } 50% { transform: scale(1.01); } 100% { transform: scale(1); } }
      </style>
      <div class="bg-gray-900 border border-gray-700 rounded-xl shadow-2xl overflow-hidden howto-enter">
        <div class="flex items-center justify-between p-3 border-b border-gray-700">
          <div class="flex items-center gap-3">
            <svg class="w-6 h-6 text-teal-400" viewBox="0 0 24 24" fill="none" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M12 20c4.418 0 8-3.582 8-8s-3.582-8-8-8-8 3.582-8 8 3.582 8 8 8z"/></svg>
            <div class="text-sm font-semibold">How to Start</div>
          </div>
          <div class="flex items-center gap-2">
            <button id="close-how-to-btn" class="text-gray-400 hover:text-white">&times;</button>
          </div>
        </div>
        <div id="how-to-panel-content" class="p-4 space-y-3 max-h-[60vh] overflow-y-auto">
          <!-- Content populated by JS -->
        </div>
        <div class="p-3 border-t border-gray-700 text-right bg-gray-800 flex items-center justify-between gap-3">
          <div class="flex items-center gap-2">
            <label class="text-xs text-gray-300">Animation</label>
            <select id="howto-animation-intensity" class="bg-gray-700 text-sm text-gray-200 rounded px-2 py-1">
              <option value="subtle">Subtle</option>
              <option value="prominent">Prominent</option>
            </select>
          </div>
          <div>
            <button id="open-full-guide-btn" class="bg-teal-600 hover:bg-teal-700 text-white font-bold py-2 px-4 rounded">Open Full Guide</button>
          </div>
        </div>
      </div>
    </div>

    <!-- How-To Full Guide Modal -->
    <div id="howto-modal" class="modal-backdrop hidden fixed inset-0 bg-black/60 z-90 items-center justify-center">
      <div class="bg-gray-900 max-w-3xl w-[90vw] max-h-[85vh] overflow-auto rounded-lg p-4 ring-1 ring-black/50">
        <div class="flex items-center justify-between mb-3">
          <h2 class="text-xl font-bold">Full How-To Guide</h2>
          <button id="howto-modal-close" class="text-gray-300 hover:text-white">‚úï</button>
        </div>
        <div id="howto-modal-content" class="prose prose-invert text-sm"></div>
      </div>
    </div>

    <!-- Modals -->

    <!-- Add Cards to Deck Modal -->
    <div id="add-cards-to-deck-modal" class="fixed inset-0 z-[60] hidden items-center justify-center p-4 modal-backdrop">
        <div class="bg-gray-800 rounded-lg shadow-2xl max-w-4xl w-full h-[90vh] flex flex-col">
            <div class="p-4 border-b border-gray-700 flex justify-between items-center">
                <h3 id="add-cards-modal-title" class="text-xl font-bold">Add Cards to Deck</h3>
                <button id="close-add-cards-modal-btn" class="text-gray-400 hover:text-white text-3xl">&times;</button>
            </div>

            <div class="flex-grow p-4 overflow-y-auto no-scrollbar">
        <div class="mb-4 space-y-2">
          <label for="add-card-modal-json-filter" class="text-xs text-gray-400">JSON / Full-text filter (paste JSON or any text to search across card data)</label>
          <textarea id="add-card-modal-json-filter" rows="4" class="w-full bg-gray-800 border border-gray-600 rounded-lg px-3 py-2 text-sm" placeholder='Paste JSON or free-text here to search across all card fields (e.g. {"oracle_text":"draw"} or "draw card").'></textarea>
          <input type="text" id="add-card-modal-filter" class="w-full bg-gray-700 border border-gray-600 rounded-lg px-4 py-2" placeholder="Filter cards by name...">
        </div>
                <div class="overflow-auto" style="max-height: calc(80vh - 150px);">
                    <table class="w-full text-sm text-left text-gray-300">
                        <thead class="text-xs text-gray-400 uppercase bg-gray-700 sticky top-0">
                            <tr>
                                <th scope="col" class="p-4">
                                    <div class="flex items-center">
                                        <input id="add-cards-select-all" type="checkbox" class="w-4 h-4 text-blue-600 bg-gray-700 border-gray-600 rounded focus:ring-blue-600 ring-offset-gray-800 focus:ring-2">
                                        <label for="add-cards-select-all" class="sr-only">checkbox</label>
                                    </div>
                                </th>
                                <th scope="col" class="px-6 py-3">Card</th>
                                <th scope="col" class="px-6 py-3">Type</th>
                                <th scope="col" class="px-6 py-3 text-center">Available</th>
                            </tr>
                        </thead>
                        <tbody id="add-cards-modal-table-body">
                            <!-- Rows will be injected here -->
                        </tbody>
                    </table>
                </div>
            </div>

            <div class="p-4 border-t border-gray-700 flex justify-between items-center">
                <span id="add-cards-selected-count" class="text-gray-400">0 cards selected</span>
                <div>
                    <button id="cancel-add-cards-to-deck-btn" class="bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded-lg">Cancel</button>
                    <button id="confirm-add-cards-to-deck-btn" class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-lg ml-2">Add Selected Cards</button>
                </div>
            </div>
        </div>
    </div>


    <!-- Card Versions Modal (for search results) -->
    <div
      id="card-versions-modal"
      class="fixed inset-0 z-[60] hidden items-center justify-center p-4 modal-backdrop"
    >
      <div
        class="bg-gray-800 rounded-lg shadow-2xl max-w-6xl w-full h-[90vh] flex flex-col"
      >
        <div
          class="p-4 border-b border-gray-700 flex justify-between items-center"
        >
          <h3 id="card-versions-modal-title" class="text-xl font-bold">
            Select Card Version
          </h3>
          <button
            id="close-versions-modal-btn"
            class="text-gray-400 hover:text-white text-3xl"
          >
            &times;
          </button>
        </div>
        <div
          id="card-versions-grid"
          class="p-6 grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-4 xl:grid-cols-5 gap-6 overflow-y-auto no-scrollbar"
        >
          <!-- Card versions will be injected here -->
        </div>
        <div
          id="versions-loading"
          class="flex-grow flex items-center justify-center"
        >
          <div
            class="animate-spin rounded-full h-12 w-12 border-b-2 border-indigo-400"
          ></div>
        </div>
      </div>
    </div>

    <!-- Card Add Confirmation Modal -->
    <div
      id="card-confirmation-modal"
      class="fixed inset-0 z-[70] hidden items-center justify-center p-4 modal-backdrop"
    >
      <div class="bg-gray-800 rounded-lg shadow-2xl max-w-6xl w-full">
        <div
          id="card-confirmation-content"
          class="p-6 grid grid-cols-1 md:grid-cols-2 gap-6 items-center"
        >
          <!-- Content injected by JS -->
        </div>
      </div>
    </div>

    <!-- Card Details Modal -->
    <div
      id="card-details-modal"
      class="fixed inset-0 z-50 hidden items-center justify-center p-4 modal-backdrop overflow-y-auto"
    >
      <div
        id="card-details-modal-content-wrapper"
        class="bg-gray-800 rounded-lg shadow-2xl max-w-[90vw] w-[90vw] h-[90vh] my-8 relative flex flex-col overflow-hidden"
      >
        <div class="absolute top-2 right-4 flex items-center gap-4 z-10">
          <button
            id="edit-card-details-btn"
            class="text-gray-400 hover:text-white"
          >
            <svg
              class="w-6 h-6"
              fill="none"
              stroke="currentColor"
              viewBox="0 0 24 24"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z"
              ></path>
            </svg>
          </button>
          <button
            id="close-card-details-btn"
            class="text-gray-400 hover:text-white text-4xl font-bold"
          >
            &times;
          </button>
        </div>
        <div id="card-details-content" class="p-6 flex-grow overflow-auto no-scrollbar">
          <!-- Content will be injected by JS -->
        </div>
      </div>
    </div>

    <!-- AI Suggestions Modal (For Deck Improvement) -->
    <div
      id="ai-suggestions-modal"
      class="fixed inset-0 z-50 hidden items-center justify-center p-4 modal-backdrop"
    >
      <div
        class="bg-gray-800 rounded-lg shadow-2xl max-w-4xl w-full h-[86vh] flex flex-col"
      >
        <div
          class="p-4 border-b border-gray-700 flex justify-between items-center"
        >
          <h3 id="ai-suggestions-title" class="text-xl font-bold">
            Gemini Deck Suggestions
          </h3>
          <button
            id="close-ai-modal-btn"
            class="text-gray-400 hover:text-white text-3xl"
          >
            &times;
          </button>
        </div>
        <div
          id="ai-chat-history"
          class="flex-grow p-4 space-y-4 overflow-y-auto no-scrollbar"
        >
          <!-- Chat messages will be injected here -->
        </div>
        <div class="p-4 border-t border-gray-700">
          <form id="ai-chat-form" class="flex gap-2">
            <input
              type="text"
              id="ai-chat-input"
              class="flex-grow bg-gray-700 border border-gray-600 rounded-lg px-4 py-2"
              placeholder="Ask a follow-up question..."
              required
            />
            <button
              type="submit"
              class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold p-2 rounded-lg flex items-center"
            >
              <span class="mtg-btn-text">Send</span>
              <div class="mtg-spinner hidden animate-spin rounded-full h-4 w-4 border-b-2 border-white ml-2" aria-hidden="true"></div>
            </button>
          </form>
          <div class="mt-3 flex items-center justify-between">
            <div id="ai-loading-indicator" class="text-sm text-gray-400 hidden"><span class="animate-pulse">Waiting for AI...</span></div>
            <div class="flex items-center gap-2">
              <button id="save-ai-conversation-btn" class="bg-gray-700 hover:bg-gray-600 text-white text-sm font-medium px-3 py-1 rounded">Save Conversation</button>
              <button id="export-ai-conversation-btn" class="bg-gray-700 hover:bg-gray-600 text-white text-sm font-medium px-3 py-1 rounded">Export JSON</button>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- AI Blueprint Modal (For Deck Creation & Viewing Strategy) -->
    <div
      id="ai-blueprint-modal"
      class="fixed inset-0 z-[60] hidden items-center justify-center p-4 modal-backdrop"
    >
      <div
        class="bg-gray-800 rounded-lg shadow-2xl max-w-3xl w-full h-[90vh] flex flex-col"
      >
        <div
          class="p-4 border-b border-gray-700 flex justify-between items-center"
        >
          <h3 id="ai-blueprint-title" class="text-xl font-bold">AI Commander Blueprint</h3>
          <button
            id="close-blueprint-modal-btn"
            class="text-gray-400 hover:text-white text-3xl"
          >
            &times;
          </button>
        </div>
        <div id="ai-blueprint-content" class="flex-grow p-6 overflow-y-auto no-scrollbar space-y-4">
          <!-- Content Injected by JS -->
        </div>
        <div id="ai-blueprint-footer" class="p-4 flex justify-end gap-4 border-t border-gray-700">
          <button
            type="button"
            id="cancel-blueprint-btn"
            class="bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded-lg"
          >
            Cancel
          </button>
          <button
            type="button"
            id="run-blueprint-suggestions-btn"
            class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-4 rounded-lg"
          >
            Run Deck Suggestions
          </button>
          <button
            type="button"
            id="confirm-blueprint-btn"
            class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-lg"
          >
            Create Deck with this Strategy
          </button>
        </div>
      </div>
    </div>

    <!-- Deck Creation Modal -->
    <div
      id="deck-creation-modal"
      class="fixed inset-0 z-50 hidden items-center justify-center p-4 modal-backdrop"
    >
      <div class="bg-gray-800 rounded-lg shadow-2xl max-w-lg w-full">
        <form id="deck-creation-form">
          <div class="p-6">
            <h3 class="text-xl font-bold mb-4">Create a New Deck</h3>
            <div class="space-y-4">
              <div>
                <label
                  for="deck-name-input"
                  class="block text-sm font-medium text-gray-300 mb-1"
                  >Deck Name (Optional)</label
                >
                <input
                  type="text"
                  id="deck-name-input"
                  class="w-full bg-gray-700 border border-gray-600 rounded-lg px-4 py-2"
                  placeholder="Gemini will name it if left blank"
                />
              </div>
              <div>
                <label
                  for="deck-format-select"
                  class="block text-sm font-medium text-gray-300 mb-1"
                  >Deck Format</label
                >
                <select
                  id="deck-format-select"
                  class="w-full bg-gray-700 border border-gray-600 rounded-lg px-4 py-2"
                >
                  <option value="commander">Commander</option>
                  <option value="standard">Standard</option>
                  <option value="modern">Modern</option>
                </select>
              </div>
              <!-- Commander Search - shown conditionally -->
              <div id="commander-selection-container" class="space-y-2 pt-2">
                <label class="block text-sm font-medium text-gray-300"
                  >Choose Commander</label
                >
                <div class="flex border-b border-gray-600">
                  <button
                    type="button"
                    id="commander-source-collection-btn"
                    class="commander-source-btn flex-1 p-2 border-b-2 border-indigo-500 text-white"
                  >
                    From Collection
                  </button>
                  <button
                    type="button"
                    id="commander-source-search-btn"
                    class="commander-source-btn flex-1 p-2 border-b-2 border-transparent text-gray-400"
                  >
                    Search New
                  </button>
                </div>
                <div id="commander-from-collection" class="mt-2">
                  <input
                    type="text"
                    id="commander-collection-filter"
                    class="w-full bg-gray-900/80 border border-gray-600 rounded-lg px-3 py-1 text-sm mb-2"
                    placeholder="Filter collection commanders..."
                  />
                  <div
                    id="commander-collection-list"
                    class="max-h-60 overflow-y-auto grid grid-cols-1 gap-1 p-1 bg-gray-900/50 rounded-md"
                  >
                    <!-- Legendary creatures from collection will be listed here -->
                  </div>
                </div>
                <div id="commander-from-search" class="hidden mt-2">
                  <div class="flex gap-2">
                    <input
                      type="text"
                      id="commander-search-input"
                      class="w-full bg-gray-700 border border-gray-600 rounded-lg px-4 py-2"
                      placeholder="Search Scryfall for a legendary creature..."
                    />
                    <button
                      type="button"
                      id="commander-search-btn"
                      class="bg-indigo-600 hover:bg-indigo-700 px-4 rounded-lg"
                    >
                      Search
                    </button>
                  </div>
                  <div
                    id="commander-search-results"
                    class="max-h-60 overflow-y-auto grid grid-cols-2 sm:grid-cols-3 gap-2 mt-2"
                  ></div>
                </div>
                <div
                  id="selected-commander-preview"
                  class="hidden items-center gap-4 p-2 bg-gray-900 rounded-lg mt-2"
                ></div>
              </div>
            </div>
            <div class="flex justify-end gap-4 mt-6">
              <button
                type="button"
                id="cancel-deck-btn"
                class="bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded-lg"
              >
                Cancel
              </button>
              <button
                type="submit"
                id="save-deck-btn"
                class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-lg flex items-center justify-center"
              >
                <span id="save-deck-text">Get AI Blueprint</span>
                <div
                  id="save-deck-spinner"
                  class="hidden animate-spin rounded-full h-5 w-5 border-b-2 border-white"
                ></div>
              </button>
            </div>
          </div>
        </form>
        <div class="mt-4 text-center text-sm text-gray-400">
          <button id="open-setup-btn" class="underline text-indigo-400">First time here? Run setup</button>
        </div>
      </div>
    </div>

    <!-- First-run Setup Modal -->
    <div id="first-run-setup" class="hidden fixed inset-0 z-[110] flex items-center justify-center bg-black/60">
      <div class="bg-gray-800 p-6 rounded-lg w-full max-w-md">
        <h2 class="text-lg font-bold mb-3">Initial Setup</h2>
        <p class="text-sm text-gray-400 mb-3">Create the admin user for this local install (email/password).</p>
        <div class="space-y-3">
          <input id="setup-email" type="email" placeholder="email@example.com" class="w-full p-2 bg-gray-700 rounded" />
          <input id="setup-password" type="password" placeholder="password" class="w-full p-2 bg-gray-700 rounded" />
        </div>
        <div class="mt-4 flex justify-end gap-2">
          <button id="cancel-setup-btn" class="px-3 py-2 rounded bg-gray-600">Cancel</button>
          <button id="run-setup-btn" class="px-3 py-2 rounded bg-indigo-600 text-white">Create User</button>
        </div>
        <div id="setup-msg" class="mt-3 text-sm text-gray-300"></div>
      </div>
    </div>

    <!-- Generic Confirmation Modal -->
    <div
      id="confirmation-modal"
      class="fixed inset-0 z-[80] hidden items-center justify-center p-4 modal-backdrop"
    >
      <div class="bg-gray-800 rounded-lg shadow-2xl max-w-sm w-full">
        <div class="p-6 text-center">
          <h3 id="confirmation-title" class="text-xl font-bold mb-2">
            Are you sure?
          </h3>
          <p id="confirmation-message" class="text-gray-400 mb-6">
            This action cannot be undone.
          </p>
          <div class="flex justify-center gap-4">
            <button
              id="confirm-action-btn"
              class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-6 rounded-lg"
            >
              Confirm
            </button>
            <button
              id="cancel-action-btn"
              class="bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-6 rounded-lg"
            >
              Cancel
            </button>
          </div>
        </div>
      </div>
    </div>

      <!-- Data Import Options Modal -->
    <div
      id="data-import-options-modal"
      class="fixed inset-0 z-[80] hidden items-center justify-center p-4 modal-backdrop"
    >
      <div class="bg-gray-800 rounded-lg shadow-2xl max-w-md w-full">
        <div class="p-6 text-center">
          <h3 class="text-xl font-bold mb-2">Import Data</h3>
          <p class="text-gray-400 mb-6">
            How would you like to import the data from your backup file?
          </p>
          <div class="flex flex-col gap-4">
            <button
              id="import-merge-btn"
              class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-6 rounded-lg"
            >
              Merge with Existing Data
            </button>
            <button
              id="import-replace-btn"
              class="bg-red-600 hover:bg-red-700 text-white font-bold py-3 px-6 rounded-lg"
            >
              Replace All Current Data
            </button>
            <button
              id="cancel-import-btn"
              class="bg-gray-600 hover:bg-gray-700 text-white font-bold py-3 px-6 rounded-lg"
            >
              Cancel
            </button>
          </div>
        </div>
      </div>
    </div>


    <!-- Deck Deletion Options Modal -->
    <div
      id="deck-delete-options-modal"
      class="fixed inset-0 z-[80] hidden items-center justify-center p-4 modal-backdrop"
    >
      <div class="bg-gray-800 rounded-lg shadow-2xl max-w-md w-full">
        <div class="p-6 text-center">
          <h3 class="text-xl font-bold mb-2">Delete Deck</h3>
          <p class="text-gray-400 mb-6">
            Do you also want to remove the cards from this deck from your
            collection?
          </p>
          <div class="flex flex-col gap-4">
            <button
              id="delete-deck-and-cards-btn"
              class="bg-red-800 hover:bg-red-700 text-white font-bold py-3 px-6 rounded-lg"
            >
              Delete Deck & Remove Cards
            </button>
            <button
              id="delete-deck-only-btn"
              class="bg-red-600 hover:bg-red-700 text-white font-bold py-3 px-6 rounded-lg"
            >
              Delete Deck Only
            </button>
            <button
              id="cancel-delete-deck-btn"
              class="bg-gray-600 hover:bg-gray-700 text-white font-bold py-3 px-6 rounded-lg"
            >
              Cancel
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Playstyle Profile Modal -->
    <div
      id="playstyle-profile-modal"
      class="fixed inset-0 z-50 hidden items-center justify-center p-4 modal-backdrop"
    >
      <div
        class="bg-gray-900 rounded-2xl shadow-2xl border border-gray-700 max-w-2xl w-full flex flex-col overflow-hidden transform transition-all scale-100"
      >
        <!-- Header -->
        <div class="p-5 border-b border-gray-800 flex justify-between items-center bg-gray-900/50">
          <div class="flex items-center gap-3">
            <div class="w-10 h-10 rounded-full bg-indigo-600 flex items-center justify-center shadow-lg shadow-indigo-500/20">
               <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19.428 15.428a2 2 0 00-1.022-.547l-2.387-.477a6 6 0 00-3.86.517l-.318.158a6 6 0 01-3.86.517L6.05 15.21a2 2 0 00-1.806.547M8 4h8l-1 1v5.172a2 2 0 00.586 1.414l5 5c1.26 1.26.367 3.414-1.415 3.414H4.828c-1.782 0-2.674-2.154-1.414-3.414l5-5A2 2 0 009 10.172V5L8 4z"></path></svg>
            </div>
            <div>
              <h3 class="text-xl font-bold text-white">Playstyle Profile</h3>
              <p class="text-sm text-gray-400">Manage your MTG preferences for better AI advice</p>
            </div>
          </div>
          <button
            id="close-playstyle-profile-modal-btn"
            class="text-gray-400 hover:text-white transition-colors p-2 rounded-lg hover:bg-gray-800"
          >
            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
            </svg>
          </button>
        </div>

        <!-- Content -->
        <div id="playstyle-profile-content" class="p-6 overflow-y-auto max-h-[60vh] space-y-4">
            <!-- Populated by JS -->
            <div class="flex justify-center py-8">
                <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-indigo-500"></div>
            </div>
        </div>
      </div>
    </div>

    <!-- Playstyle Wizard Modal -->
    <div
      id="playstyle-wizard-modal"
      class="fixed inset-0 z-50 hidden items-center justify-center p-4 modal-backdrop bg-black/80 backdrop-blur-sm transition-opacity duration-300"
    >
      <div
        class="bg-gray-900 rounded-2xl shadow-2xl border border-gray-700 max-w-4xl w-full h-[85vh] flex flex-col overflow-hidden transform transition-all scale-100"
      >
        <!-- Header -->
        <div class="p-5 border-b border-gray-800 flex justify-between items-center bg-gray-900/50">
          <div class="flex items-center gap-3">
            <div class="w-10 h-10 rounded-full bg-indigo-600 flex items-center justify-center shadow-lg shadow-indigo-500/20">
              <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"></path></svg>
            </div>
            <div>
              <h3 class="text-xl font-bold text-white">Playstyle Wizard</h3>
              <p class="text-xs text-indigo-400 font-medium">Discover your Magic identity</p>
            </div>
          </div>
          <button
            id="close-playstyle-wizard-btn"
            class="text-gray-400 hover:text-white p-2 rounded-lg hover:bg-red-900/30 hover:text-red-400 transition-colors"
          >
            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/></svg>
          </button>
        </div>

        <!-- Content -->
        <div id="playstyle-wizard-content" class="flex-grow p-6 overflow-y-auto bg-gray-900 scroll-smooth flex flex-col justify-center">
            <!-- Wizard content rendered here -->
            <div class="flex flex-col items-center justify-center h-full text-gray-500">
                <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-indigo-500 mb-4"></div>
                <p>Loading wizard...</p>
            </div>
        </div>
      </div>
    </div>

    <!-- MTG Chat Modal -->
    <div
      id="mtg-chat-modal"
      class="fixed inset-0 z-50 hidden items-center justify-center p-4 modal-backdrop bg-black/80 backdrop-blur-sm transition-opacity duration-300"
    >
      <div
        class="bg-gray-900 rounded-2xl shadow-2xl border border-gray-700 max-w-4xl w-full h-[85vh] flex flex-col overflow-hidden transform transition-all scale-100"
      >
        <!-- Header -->
        <div class="p-5 border-b border-gray-800 flex justify-between items-center bg-gray-900/50">
          <div class="flex items-center gap-3">
            <div class="w-10 h-10 rounded-full bg-indigo-600 flex items-center justify-center shadow-lg shadow-indigo-500/20">
              <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 10h.01M12 10h.01M16 10h.01M9 16H5a2 2 0 01-2-2V6a2 2 0 012-2h14a2 2 0 012 2v8a2 2 0 01-2 2h-5l-5 5v-5z"/></svg>
            </div>
            <div>
              <h3 class="text-xl font-bold text-white">MTG Forge</h3>
              <p class="text-xs text-indigo-400 font-medium">AI Strategy & Rules Assistant</p>
            </div>
          </div>
          <div class="flex items-center gap-2">
             <button
              id="save-mtg-conversation-btn"
              class="text-gray-400 hover:text-white p-2 rounded-lg hover:bg-gray-800 transition-colors"
              title="Save as Text"
            >
              <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7H5a2 2 0 00-2 2v9a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-3m-1 4l-3 3m0 0l-3-3m3 3V4"/></svg>
            </button>
            <button
              id="export-mtg-conversation-btn"
              class="text-gray-400 hover:text-white p-2 rounded-lg hover:bg-gray-800 transition-colors"
              title="Export JSON"
            >
              <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"/></svg>
            </button>
            <div class="h-6 w-px bg-gray-700 mx-1"></div>
            <button
              id="close-mtg-chat-modal-btn"
              class="text-gray-400 hover:text-white p-2 rounded-lg hover:bg-red-900/30 hover:text-red-400 transition-colors"
            >
              <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/></svg>
            </button>
          </div>
        </div>

        <!-- Chat History -->
        <div
          id="mtg-chat-history"
          class="flex-grow p-6 overflow-y-auto space-y-6 bg-gray-900 scroll-smooth"
        >
          <!-- Welcome Message -->
          <div class="flex justify-start mb-4">
            <div class="max-w-[85%] p-4 rounded-2xl rounded-bl-none bg-gray-800 text-gray-200 shadow-md">
              <p class="mb-2">üëã <strong>Welcome, Planeswalker!</strong></p>
              <p>I'm here to help with deck building, rules questions, or just chatting about Magic. What's on your mind?</p>
            </div>
          </div>
        </div>

        <!-- Input Area -->
        <div class="p-5 border-t border-gray-800 bg-gray-900/50">
          <form id="mtg-chat-form" class="relative flex items-center gap-3">
            <div class="relative flex-grow">
              <input
                type="text"
                id="mtg-chat-input"
                class="w-full bg-gray-800 text-white border border-gray-700 rounded-xl pl-4 pr-12 py-3 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-transparent shadow-inner transition-all placeholder-gray-500"
                placeholder="Ask about a card, rule, or strategy..."
                autocomplete="off"
              />
            </div>
            <button
              type="submit"
              class="bg-indigo-600 hover:bg-indigo-700 text-white p-3 rounded-xl shadow-lg shadow-indigo-500/20 transition-all transform hover:scale-105 flex items-center justify-center disabled:opacity-50 disabled:cursor-not-allowed"
            >
              <span class="mtg-btn-text hidden">Send</span> <!-- Hidden text for accessibility -->
              <svg class="w-6 h-6 mtg-btn-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8"/></svg>
              <div class="mtg-spinner hidden animate-spin rounded-full h-5 w-5 border-2 border-white border-t-transparent absolute"></div>
            </button>
          </form>
          <p class="text-center text-xs text-gray-600 mt-3">AI can make mistakes. Verify important rules.</p>
        </div>
      </div>
    </div>

    <!-- New Player Guide Modal -->
    <div
      id="new-player-guide-modal"
      class="fixed inset-0 z-50 hidden items-center justify-center p-4 modal-backdrop"
    >
      <div
        class="bg-gray-800 rounded-lg shadow-2xl max-w-3xl w-full h-[80vh] flex flex-col"
      >
        <div
          class="p-4 border-b border-gray-700 flex justify-between items-center"
        >
          <h3 class="text-xl font-bold">New Player Guide</h3>
          <button
            id="close-new-player-guide-modal-btn"
            class="text-gray-400 hover:text-white text-3xl"
          >
            &times;
          </button>
        </div>
        <div class="flex-grow p-6 space-y-4 overflow-y-auto no-scrollbar">
          <details class="bg-gray-900/50 p-4 rounded-lg">
            <summary class="font-semibold text-lg hover:text-indigo-400">
              The Colors of Magic
            </summary>
            <div class="mt-4 space-y-3 text-gray-300">
              <p>
                <strong>White (W):</strong> The color of order, law, and
                community. White excels at creating armies of small creatures,
                protecting them with enchantments, gaining life, and using
                powerful spells that affect all players equally to level the
                playing field.
              </p>
              <p>
                <strong>Blue (U):</strong> The color of knowledge, manipulation,
                and deceit. Blue is the master of controlling the game by
                countering opponent's spells, drawing extra cards to find the
                right answers, and controlling the board with tricky creatures
                (often with flying) and illusions.
              </p>
              <p>
                <strong>Black (B):</strong> The color of ambition, death, and
                power at any cost. Black is willing to sacrifice anything‚Äîlife,
                creatures, cards in hand‚Äîto win. It is the undisputed master of
                destroying creatures, forcing opponents to discard cards, and
                reanimating creatures from any graveyard.
              </p>
              <p>
                <strong>Red (R):</strong> The color of chaos, freedom, and
                impulse. Red wants to win, and it wants to win now. It uses
                direct damage spells ("burn") to destroy creatures or attack the
                opponent directly, and deploys fast creatures with haste to keep
                the pressure on.
              </p>
              <p>
                <strong>Green (G):</strong> The color of nature, growth, and
                brute force. Green is all about playing massive, powerful
                creatures. It excels at "ramping" its mana‚Äîgetting more lands
                into play faster than normal‚Äîto cast its huge threats far ahead
                of schedule.
              </p>
            </div>
          </details>

          <details class="bg-gray-900/50 p-4 rounded-lg">
            <summary class="font-semibold text-lg hover:text-indigo-400">
              Anatomy of a Deck
            </summary>
            <div class="mt-4 space-y-3 text-gray-300">
              <p class="text-sm text-gray-400">
                Note: These are general guidelines. Ratios change dramatically
                based on strategy!
              </p>
              <h4 class="font-bold text-md text-indigo-300">
                Typical 60-Card Deck (Standard, Modern, etc.)
              </h4>
              <ul class="list-disc list-inside">
                <li>
                  <strong>~24 Lands:</strong> This is the most crucial number.
                  Too few and you won't be able to cast your spells; too many
                  and you'll run out of things to do.
                </li>
                <li>
                  <strong>~20-25 Creatures:</strong> The core of most
                  strategies. These are your attackers and blockers.
                </li>
                <li>
                  <strong>~11-16 Other Spells:</strong> This includes removal,
                  card draw, and any other spells that support your
                  creature-based game plan.
                </li>
              </ul>
              <h4 class="font-bold text-md text-indigo-300 mt-4">
                Typical 100-Card Deck (Commander/EDH)
              </h4>
              <ul class="list-disc list-inside">
                <li>
                  <strong>1 Commander:</strong> Your legendary creature that
                  defines the deck's colors and strategy.
                </li>
                <li>
                  <strong>~37-38 Lands:</strong> You need more lands in
                  Commander due to the higher mana costs and longer games.
                </li>
                <li>
                  <strong>~10-12 Ramp/Mana Rocks:</strong> Spells or artifacts
                  that help you generate extra mana. Crucial for keeping up.
                </li>
                <li>
                  <strong>~10 Card Draw:</strong> Spells that let you draw more
                  cards. Essential for not running out of gas in a long game.
                </li>
                <li>
                  <strong>~10-12 Interaction/Removal:</strong> Ways to deal with
                  your opponents' threats.
                </li>
                <li>
                  <strong>~28-30 "Theme" Cards:</strong> These are the
                  creatures, spells, and other cards that work with your
                  commander to execute your deck's main strategy.
                </li>
              </ul>
            </div>
          </details>

          <details class="bg-gray-900/50 p-4 rounded-lg">
            <summary class="font-semibold text-lg hover:text-indigo-400">
              Common Playstyles (Archetypes)
            </summary>
            <div class="mt-4 space-y-3 text-gray-300">
              <p>
                <strong>Aggro (Aggressive):</strong> The goal is to win as
                quickly as possible, usually by attacking with cheap, efficient
                creatures. Aggro decks try to overwhelm the opponent before they
                can execute their own, more powerful late-game strategy. They
                live by the motto, "the best defense is a good offense."
              </p>
              <p>
                <strong>Control:</strong> The polar opposite of Aggro. Control
                decks aim to survive the early game by countering the opponent's
                key spells and destroying their creatures. They win the game in
                the long run by using powerful spells, planeswalkers, or a
                single, hard-to-kill creature once the opponent has run out of
                resources.
              </p>
              <p>
                <strong>Midrange:</strong> The jack-of-all-trades. Midrange
                decks are flexible, able to play defensively against Aggro decks
                and then switch gears to be the aggressor against slower Control
                decks. They focus on playing individually powerful and efficient
                cards that are good in almost any situation.
              </p>
              <p>
                <strong>Combo (Combination):</strong> These decks aim to
                assemble a specific combination of two or more cards that
                results in an instant win or an insurmountable advantage. Combo
                decks often feel like they are "playing solitaire," as they can
                sometimes ignore what the opponent is doing to focus entirely on
                finding their winning pieces.
              </p>
              <p>
                <strong>Tempo:</strong> A close cousin of Aggro. Tempo decks
                play an early threat and then protect it by cheaply disrupting
                the opponent's game plan just long enough to win. They use
                spells to bounce creatures back to their owner's hand or tap
                them down to clear the way for attacks, keeping their opponent
                constantly off-balance.
              </p>
            </div>
          </details>
        </div>
      </div>
    </div>

    <!-- Card Hover Preview -->
    <div id="card-hover-preview" class="fixed top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 z-[80] hidden pointer-events-none transition-all duration-200">
        <img src="" class="rounded-xl shadow-2xl shadow-black/50" style="max-height: 85vh; max-width: 85vw; object-fit: contain;">
    </div>

    <!-- Notification Modal -->
    <div
      id="notification-modal"
      class="fixed inset-0 z-[90] hidden items-center justify-center p-4 modal-backdrop"
    >
      <div
        class="bg-gray-800 rounded-lg shadow-xl p-6 w-full max-w-sm text-center"
      >
        <h3
          id="notification-title"
          class="text-lg font-bold mb-2 text-red-400"
        ></h3>
        <p id="notification-message" class="text-gray-300"></p>
        <button
          id="notification-close-btn"
          class="mt-4 w-full bg-indigo-600 text-white font-bold py-2 px-4 rounded-lg"
        >
          Close
        </button>
      </div>
    </div>

    <!-- Firebase and App Logic -->
    <!-- Load modular JS (transitional) -->
    <script type="module" src="js/main/index.js"></script>
    <script type="module" src="js/lib/ui.js"></script>
    <script type="module" src="js/lib/data.js"></script>
    <script type="module" src="js/pages/collection.js"></script>
    <script type="module" src="js/pages/decks.js"></script>
    <script type="module" src="js/pages/singleDeck.js"></script>
    <script type="module" src="js/pages/sets.js"></script>
    <script type="module" src="js/pages/set_details.js"></script>
  <script type="module" src="js/main/app.js"></script>
  <!-- Load the extracted Public/app.js as a module so its ES module imports
    execute and it can register window.__module_handle* handlers that
    the boot script expects. -->
  <script type="module" src="app.js"></script>
  <!-- DOMPurify for sanitizing AI-provided HTML responses (no SRI to avoid integrity mismatch) -->
  <script src="https://cdn.jsdelivr.net/npm/dompurify@2.5.4/dist/purify.min.js"></script>
  <script type="module" src="js/main/boot.js"></script>
  <script>
    // NOTE: The legacy test proxy `window.__runFirstRunSetup` was removed.
    // Tests should call the canonical handler `window.handleFirstRunSetup(email, password)`
    // If your test runner needs a shim, add a short-lived helper in your test harness.
  </script>

    <script>
      // Resilient boot shim: some browsers/environments may load module scripts
      // slightly after this inline block runs. Poll for the module-attached
      // boot functions and invoke them when available. This keeps the page
      // responsive in environments where module execution order is subject to
      // timing differences.
      (function resilientBoot() {
        const tryBoot = () => {
          try {
            if (typeof window.bootApp === 'function') {
              try { window.bootApp(); console.log('[BootShim] window.bootApp invoked'); } catch (e) { console.warn('[BootShim] bootApp threw', e); }
            }
            if (typeof window.initAppListeners === 'function') {
              // Defer the call to avoid synchronous exceptions from third-party SDK race conditions
              try {
                setTimeout(() => {
                  try {
                    window.initAppListeners();
                    console.log('[BootShim] window.initAppListeners invoked (deferred)');
                  } catch (e) {
                    console.warn('[BootShim] deferred initAppListeners threw', e);
                  }
                }, 50);
              } catch (e) {
                console.warn('[BootShim] scheduling initAppListeners failed', e);
              }
            }
          } catch (e) {
            console.warn('Modular boot/init failed or not available yet', e);
          }
        };

        // First immediate attempt
        tryBoot();

        // If the boot functions are not present yet, poll for a short window.
        let attempts = 0;
        const maxAttempts = 25; // ~5 seconds (25 * 200ms)
        const iv = setInterval(() => {
          attempts++;
          if (typeof window.bootApp === 'function' || typeof window.initAppListeners === 'function') {
            tryBoot();
            clearInterval(iv);
            return;
          }
          if (attempts >= maxAttempts) {
            clearInterval(iv);
            console.warn('[BootShim] boot functions not detected after wait; UI modules may not be initialized.');
          }
        }, 200);
      })();
    </script>
  <script>
    // How-To Panel: contextual guided start helper
    (function(){
      const btn = document.getElementById('how-to-start-btn');
      const panel = document.getElementById('how-to-panel');
      const closeBtn = document.getElementById('close-how-to-btn');
      const content = document.getElementById('how-to-panel-content');
      const openFullGuide = document.getElementById('open-full-guide-btn');

      if (!btn || !panel || !content) return;

      const SECTIONS = [
        { id: 'playstyle', title: '1. Set Your Playstyle', desc: 'Open Playstyle from the header to set preferences. This personalizes AI suggestions and blueprints.' },
        { id: 'add-cards', title: '2. Add Cards to Your Collection', desc: 'Use the Add Card search to find prints on Scryfall, select versions, set quantity/finish, and add them.' },
        { id: 'add-decks', title: '3. Create Decks', desc: 'Open Decks ‚Üí Create New Deck. For Commander, pick a commander then request an AI blueprint if desired.' },
        { id: 'collection-filters', title: '4. Filter & Group Your Collection', desc: 'Use Quick Filter, Group By, and saved views to organize the display.' },
        { id: 'ai-tools', title: '5. Use AI Tools', desc: 'AI features include Deck Suggestions, Rule Lookup, and MTG Chat. Add your Gemini API key to enable them.' },
        { id: 'data-mgmt', title: '6. Import / Export & Data Management', desc: 'Export All Data or Import backups from Settings. Use Replace with caution (it deletes current data).' },
        { id: 'danger-zone', title: '7. Danger Zone', desc: 'Clear All Account Data (permanent). This is irreversible; use the confirmation dialog.' }
      ];

  function renderSections(activeView) {
        // activeView: 'collection'|'decks'|'singleDeck'|'settings'
        let ordered = [];
        // Default preferred order: playstyle -> add cards -> add decks -> rest
        ordered = ['playstyle','add-cards','add-decks','collection-filters','ai-tools','data-mgmt','danger-zone'];

        // If on Settings page, put settings-related sections up top
        if (activeView === 'settings') {
          ordered = ['data-mgmt','danger-zone','collection-filters','playstyle','add-cards','add-decks','ai-tools'];
        }

        // If on Decks or singleDeck, highlight deck-related steps first
        if (activeView === 'decks' || activeView === 'singleDeck') {
          ordered = ['playstyle','add-cards','add-decks','ai-tools','collection-filters','data-mgmt','danger-zone'];
        }

        // Compose HTML
        content.innerHTML = ordered.map((id, idx) => {
          const s = SECTIONS.find(x => x.id === id);
          if (!s) return '';
          const isActive = (function(){
            if (activeView === 'collection' && (id==='add-cards' || id==='collection-filters')) return true;
            if ((activeView === 'decks' || activeView === 'singleDeck') && (id==='add-decks' || id==='ai-tools')) return true;
            if (activeView === 'settings' && (id==='data-mgmt' || id==='danger-zone')) return true;
            if (id==='playstyle' && ['collection','decks','singleDeck','settings'].includes(activeView)) return true;
            return false;
          })();

          return `
            <div class="p-3 rounded-lg ${isActive ? 'ring-2 ring-teal-500 bg-gray-800' : 'bg-gray-900'}">
              <div class="flex items-start justify-between gap-3">
                <div>
                  <div class="text-sm font-semibold ${isActive ? 'text-teal-300' : 'text-gray-200'}">${s.title}</div>
                  <div class="text-xs text-gray-400 mt-1">${s.desc}</div>
                </div>
                <div class="text-xs text-gray-500">Step ${idx+1}</div>
              </div>
            </div>
          `;
        }).join('');

        // Post-process DOM to add our animation/highlight classes to the active step(s)
        try {
          // remove from all first
          content.querySelectorAll('.howto-active-step, .howto-pulse').forEach(n => n.classList.remove('howto-active-step','howto-pulse'));
          // Add to items that appear to be active (teal text or ring)
          const candidates = Array.from(content.children || []).filter(el => el.querySelector('.text-sm.font-semibold.text-teal-300') || el.classList.contains('ring-2') );
          if (candidates.length > 0) {
            const primary = candidates[0];
            primary.classList.add('howto-active-step','howto-pulse');
          }
        } catch (err) { /* ignore DOM quirks */ }
      }

      function getCurrentView() {
        try {
          const views = { collection: document.getElementById('collection-view'), decks: document.getElementById('decks-view'), singleDeck: document.getElementById('single-deck-view'), settings: document.getElementById('settings-view') };
          for (const k in views) {
            const el = views[k]; if (!el) continue; if (!el.classList.contains('hidden')) return k;
          }
        } catch (e) {}
        return 'collection';
      }

      btn.addEventListener('click', () => {
        const view = getCurrentView();
        renderSections(view);
        panel.classList.toggle('hidden');
        panel.classList.toggle('flex');
      });
      closeBtn && closeBtn.addEventListener('click', () => { panel.classList.add('hidden'); panel.classList.remove('flex'); });
      openFullGuide && openFullGuide.addEventListener('click', () => {
        // open settings and scroll to saved views as a proxy for the full guide
        try { if (typeof window.showView === 'function') window.showView('settings'); } catch (e) {
          const settingsView = document.getElementById('settings-view'); const collectionView = document.getElementById('collection-view'); if (settingsView && collectionView) { collectionView.classList.add('hidden'); settingsView.classList.remove('hidden'); }
        }
        // re-render with settings active
        setTimeout(() => { renderSections('settings'); }, 150);
      });

      // Event-driven updates: listen for a custom view-change event dispatched by the app
      window.addEventListener('mtg:viewchange', (e) => {
        try {
          const v = e && e.detail && e.detail.view ? e.detail.view : getCurrentView();
          // Only update panel if visible to avoid unnecessary work
          if (!panel.classList.contains('hidden')) renderSections(v);
          // Highlight header nav buttons based on view
          try {
            document.querySelectorAll('.nav-link').forEach(n => n.classList.remove('nav-active'));
            const map = { collection: 'nav-collection', decks: 'nav-decks', settings: 'nav-settings' };
            const el = document.getElementById(map[v]); if (el) el.classList.add('nav-active');
          } catch (innerErr) { /* ignore */ }
        } catch (err) { console.debug('mtg:viewchange handler error', err); }
      });

      // Also render once on initial load
      renderSections(getCurrentView());

      // Wire Open Full Guide to fetch HOWTO.md and show modal
      (function wireFullGuideModal() {
        const openBtn = document.getElementById('open-full-guide-btn');
        const modal = document.getElementById('howto-modal');
        const modalClose = document.getElementById('howto-modal-close');
        const modalContent = document.getElementById('howto-modal-content');
        const intensity = document.getElementById('howto-animation-intensity');

        function simpleMdToHtml(md) {
          // Very small markdown to HTML converter for headings, lists, paragraphs, bold, italics, links
          let html = md
            .replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
          // headings
          html = html.replace(/^### (.*$)/gim, '<h3>$1</h3>');
          html = html.replace(/^## (.*$)/gim, '<h2>$1</h2>');
          html = html.replace(/^# (.*$)/gim, '<h1>$1</h1>');
          // bold/italic
          html = html.replace(/\*\*(.*?)\*\*/gim, '<strong>$1</strong>');
          html = html.replace(/\*(.*?)\*/gim, '<em>$1</em>');
          // links
          html = html.replace(/\[(.*?)\]\((.*?)\)/gim, '<a href="$2" target="_blank" rel="noopener noreferrer">$1</a>');
          // unordered lists
          html = html.replace(/(^|\n)\s*[-\*] (.*)/gim, '$1<li>$2</li>');
          html = html.replace(/(<li>.*<\/li>\s*)+/gim, (m) => '<ul>' + m.replace(/\n/g,'') + '</ul>');
          // paragraphs
          html = html.replace(/^(?!<h|<ul|<li|<blockquote|<pre)([^\n]+)\n?/gim, '<p>$1</p>');
          return html;
        }

        async function loadHowTo() {
          // Try HTML first (rich content). If unavailable, fallback to markdown.
          try {
            const resHtml = await fetch('HOWTO.html');
            if (resHtml && resHtml.ok) {
              const html = await resHtml.text();
              // DOMPurify is loaded earlier on the page; sanitize before inserting
              try {
                modalContent.innerHTML = DOMPurify ? DOMPurify.sanitize(html) : html;
                return;
              } catch (e) {
                console.warn('DOMPurify not available or sanitize failed', e);
                modalContent.innerHTML = html;
                return;
              }
            }
          } catch (e) { /* ignore and fallback */ }

          // fallback to markdown
          try {
            const res = await fetch('HOWTO.md');
            if (!res.ok) throw new Error('Fetch failed');
            const md = await res.text();
            modalContent.innerHTML = simpleMdToHtml(md);
          } catch (err) {
            modalContent.innerHTML = '<p class="text-red-400">Could not load guide.</p>';
            console.error('Failed to load HOWTO (html/md)', err);
          }
        }

        openBtn && openBtn.addEventListener('click', async () => {
          await loadHowTo();
          modal.classList.remove('hidden');
          modal.classList.add('flex');
          // set animation intensity classes on panel (so user preview matches modal setting)
          const panelRoot = document.querySelector('#how-to-panel > div');
          if (panelRoot) {
            if (intensity && intensity.value === 'prominent') {
              panelRoot.style.boxShadow = '0 10px 30px rgba(16,185,129,0.15)';
              panelRoot.style.border = '1px solid rgba(16,185,129,0.9)';
            } else {
              panelRoot.style.boxShadow = '';
              panelRoot.style.border = '';
            }
          }
        });

        modalClose && modalClose.addEventListener('click', () => {
          modal.classList.add('hidden');
          modal.classList.remove('flex');
        });

        // intensity selector affects pulse amplitude by toggling a class on panel content
        intensity && intensity.addEventListener('change', (e) => {
          const val = e.target.value;
          const contentEl = document.getElementById('how-to-panel-content');
          if (!contentEl) return;
          if (val === 'prominent') {
            contentEl.querySelectorAll('.howto-pulse').forEach(n => n.style.transform = 'scale(1.02)');
          } else {
            contentEl.querySelectorAll('.howto-pulse').forEach(n => n.style.transform = 'scale(1)');
          }
        });
      })();
    })();
  </script>

  <script type="module">
      // --- Modal Visibility Settings Global ---

      // --- Saved Views State (global, for advanced view builder) ---
      window.savedViews = window.savedViews || [];
      window.activeViewId = typeof window.activeViewId !== 'undefined' ? window.activeViewId : null;
      window.modalVisibilitySettings = window.modalVisibilitySettings || {
        count: true,
        finish: true,
        condition: true,
        purchasePrice: true,
        notes: true
      };

      // --- Edit View Button Logic ---
      document.addEventListener('DOMContentLoaded', () => {
        const editBtn = document.getElementById('open-view-builder-btn');
        const viewBuilderPanel = document.getElementById('view-builder-panel');
        if (editBtn && viewBuilderPanel) {
          editBtn.addEventListener('click', () => {
            viewBuilderPanel.classList.remove('hidden');
            // Optionally scroll into view
            viewBuilderPanel.scrollIntoView({ behavior: 'smooth', block: 'center' });
          });
        }
      });

      // --- Collapsible UI for Add Card, KPI, and Filters bars ---
      function setupCollapsibleSection(toggleBtnId, sectionId, chevronId) {
        const btn = document.getElementById(toggleBtnId);
        const section = document.getElementById(sectionId);
        const chevron = document.getElementById(chevronId);
        if (!btn || !section || !chevron) return;
        btn.addEventListener('click', () => {
          const expanded = btn.getAttribute('aria-expanded') === 'true';
          btn.setAttribute('aria-expanded', String(!expanded));
          section.style.display = expanded ? 'none' : '';
          chevron.textContent = expanded ? '‚ñ∫' : '‚ñº';
        });
        // Keyboard accessibility: toggle on Enter/Space
        btn.addEventListener('keydown', (e) => {
          if (e.key === 'Enter' || e.key === ' ') {
            e.preventDefault();
            btn.click();
          }
        });
      }
      document.addEventListener('DOMContentLoaded', () => {
        setupCollapsibleSection('toggle-add-card-section', 'add-card-section', 'add-card-section-chevron');
        setupCollapsibleSection('toggle-kpi-bar', 'collection-kpi-bar', 'kpi-bar-chevron');
        setupCollapsibleSection('toggle-filters-bar', 'collection-filters-bar', 'filters-bar-chevron');
        // Manage Saved Views button should navigate to Settings and focus the Saved Views widget
        const manageBtn = document.getElementById('manage-views-btn');
        if (manageBtn) {
          manageBtn.addEventListener('click', (e) => {
            try {
              if (typeof window.showView === 'function') {
                window.showView('settings');
                setTimeout(() => {
                  const el = document.getElementById('settings-saved-views'); if (el) el.scrollIntoView({ behavior: 'smooth', block: 'center' });
                  if (typeof window.renderSettingsSavedViews === 'function') window.renderSettingsSavedViews();
                }, 120);
              } else {
                // fallback: toggle view visibility manually
                const settingsView = document.getElementById('settings-view');
                const collectionView = document.getElementById('collection-view');
                if (settingsView && collectionView) {
                  collectionView.classList.add('hidden'); settingsView.classList.remove('hidden');
                  const el = document.getElementById('settings-saved-views'); if (el) el.scrollIntoView({ behavior: 'smooth', block: 'center' });
                  if (typeof window.renderSettingsSavedViews === 'function') window.renderSettingsSavedViews();
                }
              }
            } catch (err) { console.debug('manage-views btn handler failed', err); }
          });
        }
      });
      // Use the local firebase wrappers to avoid creating duplicate SDK instances
      import { app as firebaseApp, db as firebaseDb, auth as firebaseAuth, appId as initAppId } from './js/firebase/init.js';
      import { onAuthStateChanged, signOut, GoogleAuthProvider, signInWithPopup, createUserWithEmailAndPassword, signInWithEmailAndPassword, signInAnonymously, signInWithCustomToken } from './js/firebase/auth.js';
      import {
        doc,
        getDoc,
        collection,
        onSnapshot,
        addDoc,
        deleteDoc,
        updateDoc,
        writeBatch,
        getDocs,
        setDoc,
        deleteField,
        runTransaction,
      } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

  document.addEventListener("DOMContentLoaded", () => {
        // Runtime check: warn if multiple Firebase apps or auth instances detected
        try {
          const globalApps = (window.__firebase_app ? [window.__firebase_app] : []).length + (window.firebase && Array.isArray(window.firebase.apps) ? window.firebase.apps.length : 0);
          if (globalApps > 1) {
            console.warn('[Firebase] Multiple firebase apps detected on window. This can cause inconsistent SDK instances (auth/onAuthStateChanged errors).');
          }
          if (window.__firebase_auth && window.__firebase_auth !== firebaseAuth) {
            console.warn('[Firebase] Multiple auth instances detected (window.__firebase_auth differs from local firebaseAuth).');
          }
        } catch (e) { /* best-effort check */ }
        // View builder management lives in Settings page now. Collection keeps only the dropdown.

        // Saved view actions moved to Settings page; collection view no longer wires save handler here.

        // Remove filter/sort rule handlers (delegated in renderViewBuilderLists)
        window.renderViewBuilderLists = function() {
          const filtersList = document.getElementById('filters-list');
          const sortsList = document.getElementById('sorts-list');
          filtersList.innerHTML = (window.viewFilterRules||[]).map((r, i) => `<div class="flex items-center gap-2"><span class="text-sm text-gray-200">${r.column} ${r.operator} \"${r.value}\"</span><button data-i="${i}" class="remove-filter-btn text-sm text-red-400 ml-2">Remove</button></div>`).join('') || '<div class="text-sm text-gray-500">No filters</div>';
          sortsList.innerHTML = (window.viewSortRules||[]).map((s, i) => `<div class="flex items-center gap-2"><span class="text-sm text-gray-200">${i+1}. ${s.column} ${s.direction}</span><button data-i="${i}" class="remove-sort-btn text-sm text-red-400 ml-2">Remove</button></div>`).join('') || '<div class="text-sm text-gray-500">No sorts</div>';
          document.querySelectorAll('.remove-filter-btn').forEach(btn => btn.addEventListener('click', (e) => {
            const idx = parseInt(btn.dataset.i);
            window.viewFilterRules.splice(idx, 1);
            window.renderViewBuilderLists();
          }));
          document.querySelectorAll('.remove-sort-btn').forEach(btn => btn.addEventListener('click', (e) => {
            const idx = parseInt(btn.dataset.i);
            window.viewSortRules.splice(idx, 1);
            window.renderViewBuilderLists();
          }));
        };
        if (typeof renderViewBuilderLists === 'function') renderViewBuilderLists();
        console.log(
          "[DOMContentLoaded] Event fired. App is initializing. Find in <script> block."
        );

  // --- FIREBASE & APP CONFIG ---
        let db, auth;
        let userId = null;
        let collectionUnsubscribe = null;
        let decksUnsubscribe = null;

        const appId =
          typeof __app_id !== "undefined" ? __app_id : "mtg-forge-default";
        console.log(`[Config] App ID set to: ${appId}`);

        const firebaseConfig =
          typeof __firebase_config !== "undefined"
            ? JSON.parse(__firebase_config)
            : {
                apiKey: "AIzaSyAdqbFNjrB6y-8BrMEYYCT5ywiCgZVtMaE",
                authDomain: "mtglibrary-70b46.firebaseapp.com",
                projectId: "mtglibrary-70b46",
                storageBucket: "mtglibrary-70b46.firebasestorage.app",
                messagingSenderId: "602862103839",
                appId: "1:602862103839:web:23c64b7486c058c903d42a",
                measurementId: "G-EWELJJQ631",
              };
        console.log("[Config] Firebase config loaded.");

  // Reuse the already-initialized Firebase app/db/auth from our local init module.
  const app = firebaseApp;
  db = firebaseDb;
  auth = firebaseAuth;

        // If a user is already signed in at page load, ensure the app UI is shown
        try {
          const cur = auth && auth.currentUser ? auth.currentUser : (window.__firebase_auth && window.__firebase_auth.currentUser) || null;
          if (cur) {
            console.log('[Auth] user present on load, showing app UI', cur.uid);
            try { document.getElementById('login-screen').classList.add('hidden'); } catch(e){}
            try { document.getElementById('app-wrapper').classList.remove('hidden'); } catch(e){}
            try { if (typeof window.initAppListeners === 'function') window.initAppListeners(); } catch(e) { console.warn('[Auth] initAppListeners call on load failed', e); }
          }
        } catch (e) { /* best-effort */ }
        
  // Gemini API key removed from source. Per-user keys are stored encrypted in Firestore.
  // Use the runtime getter window.getGeminiUrl() (provided by Public/js/firebase/gemini.js).
  console.log("[Config] Gemini API: per-user key required; configure in Settings.");

        // --- STATE ---
        let currentCardForAdd = null;
        let currentCommanderForAdd = null;
        let tempAiBlueprint = null;
        let localCollection = {};
  let tempImportedData = null;
        let localDecks = {};
        let cardDeckAssignments = {};
        let deckChartInstances = {};
        let collectionViewMode = "grid";
        let collectionGridSize = "md";
        let collectionSortState = { column: "name", direction: "asc" };
        let collectionCurrentPage = 1;
        const COLLECTION_PAGE_SIZE = 100;
        let currentSearchContext = {
          mode: "collection",
          deckId: null,
        };
        // --- Advanced View System ---
        window.viewFilterRules = window.viewFilterRules || [];
        window.viewSortRules = window.viewSortRules || [];
  // --- Advanced View System ---
  // (duplicate state block removed)
  console.log("[State] Initial application state variables declared.");
        // --- Saved Views / Advanced Filters ---

        function renderSavedViewsSelect() {
          // migrated to Public/js/settings/settings.js
          import('./js/settings/settings.js').then(mod => {
            if (typeof mod.renderSavedViewsSelect === 'function') mod.renderSavedViewsSelect();
          }).catch(err => console.debug('settings module not yet available for renderSavedViewsSelect', err));
        }

        async function loadSavedViewsFromFirestore() {
          // migrated to Public/js/settings/settings.js
          try {
            const mod = await import('./js/settings/settings.js');
            if (typeof mod.loadSavedViewsFromFirestore === 'function') return mod.loadSavedViewsFromFirestore();
            // make sure playstyle is loaded too
            try { await import('./js/settings/playstyle.js'); if (window.userId && window.playstyle && typeof window.playstyle.loadPlaystyleForUser === 'function') await window.playstyle.loadPlaystyleForUser(window.userId); } catch (e) {}
          } catch (err) {
            console.debug('settings module not yet available for loadSavedViewsFromFirestore', err);
          }
        }

        async function persistSavedViewsToFirestore() {
          // migrated to Public/js/settings/settings.js
          try {
            const mod = await import('./js/settings/settings.js');
            if (typeof mod.persistSavedViewsToFirestore === 'function') return mod.persistSavedViewsToFirestore();
            try { await import('./js/settings/playstyle.js'); } catch (e) {}
          } catch (err) {
            console.debug('settings module not yet available for persistSavedViewsToFirestore', err);
          }
        }

        function buildFilterPredicate(rule) {
          // migrated to Public/js/settings/settings.js
          // Delegate to the settings module implementation when available
          try {
            const modPromise = import('./js/settings/settings.js');
            // return a predicate that delegates once module loads
            return (card) => {
              // If module loaded and exported predicate builder, use it
              if (window.__settings_buildFilterPredicate) return window.__settings_buildFilterPredicate(rule)(card);
              // Fallback simple contains compare
              const col = rule.column; const val = (rule.value||'').toString().toLowerCase();
              const cardVal = ((col === 'color_identity' ? (card.color_identity||[]).join('') : (card[col]||'')).toString()||'').toLowerCase();
              return cardVal.includes(val);
            };
          } catch (err) {
            console.debug('settings module not yet available for buildFilterPredicate', err);
            return (card) => true;
          }
        }

        function applySavedViewToCards(cardsArr) {
          // migrated to Public/js/settings/settings.js
          // Delegate to module when available
          if (window.__applySavedViewToCards) return window.__applySavedViewToCards(cardsArr);
          // Fallback: naive apply using viewFilterRules/viewSortRules
          let result = [...cardsArr];
          for (const rule of viewFilterRules) {
            const pred = buildFilterPredicate(rule);
            result = result.filter(pred);
          }
          if (viewSortRules.length > 0) {
            result.sort((a,b) => {
              for (const s of viewSortRules) {
                const col = s.column;
                const dir = s.direction === 'asc' ? 1 : -1;
                let valA = a[col] ?? '';
                let valB = b[col] ?? '';
                if (col === 'price') { valA = parseFloat(a.prices?.usd||0); valB = parseFloat(b.prices?.usd||0); }
                if (col === 'count') { valA = a.count||1; valB = b.count||1; }
                if (typeof valA === 'string') valA = valA.toLowerCase();
                if (typeof valB === 'string') valB = valB.toLowerCase();
                if (valA < valB) return -1 * dir;
                if (valA > valB) return 1 * dir;
              }
              return 0;
            });
          }
          return result;
        }

        async function saveViewToFirestore(view) {
          // migrated to Public/js/settings/settings.js
          try {
            const mod = await import('./js/settings/settings.js');
            if (typeof mod.saveViewToFirestore === 'function') return mod.saveViewToFirestore(view);
          } catch (err) {
            console.debug('settings module not yet available for saveViewToFirestore', err);
          }
        }

        async function deleteViewFromFirestore(viewId) {
          // migrated to Public/js/settings/settings.js
          try {
            const mod = await import('./js/settings/settings.js');
            if (typeof mod.deleteViewFromFirestore === 'function') return mod.deleteViewFromFirestore(viewId);
          } catch (err) {
            console.debug('settings module not yet available for deleteViewFromFirestore', err);
          }
        }

        function setActiveViewById(viewId) {
          // migrated to Public/js/settings/settings.js
          import('./js/settings/settings.js').then(mod => {
            if (typeof mod.setActiveViewById === 'function') return mod.setActiveViewById(viewId);
          }).catch(err => console.debug('settings module not yet available for setActiveViewById', err));
        }

        // --- DOM ELEMENTS ---
        const views = {
          collection: document.getElementById("collection-view"),
          decks: document.getElementById("decks-view"),
          sets: document.getElementById("sets-view"),
          'set-details': document.getElementById("set-details-view"),
          singleDeck: document.getElementById("single-deck-view"),
          settings: document.getElementById("settings-view"),
          // Precons UI (added by precons feature)
          precons: document.getElementById("precons-view"),
          precon: document.getElementById("precon-view"),
        };

        const navLinks = {
          collection: document.getElementById("nav-collection"),
          decks: document.getElementById("nav-decks"),
          sets: document.getElementById("nav-sets"),
          // Precons nav link (sidebar) - commented out since button is hidden
          // precons: document.getElementById("nav-precons"),
          settings: document.getElementById("nav-settings"),
          ruleLookup: document.getElementById("nav-rule-lookup"),
          generalChat: document.getElementById("nav-general-chat"),
        };

        // --- INITIALIZATION ---

  // Use the canonical auth instance exported from our firebase init wrapper
  onAuthStateChanged(auth, async (user) => {
          if (user) {
            userId = user.uid;
            console.log(`[Auth] User is signed in. UID: ${userId}`);
            document.getElementById("user-email").textContent =
              user.email || "Anonymous User";
            document.getElementById("login-screen").classList.add("hidden");
            document.getElementById("app-wrapper").classList.remove("hidden");
            await loadSettings(); // Ensure settings are loaded before first render
            setupListeners();
          } else {
            console.log("[Auth] No user signed in. Showing login UI (email/password).");
            // Prefer explicit email/password login. If an initial custom token exists (CI/special flows), try it.
            if (typeof __initial_auth_token !== "undefined") {
              try {
                await signInWithCustomToken(auth, __initial_auth_token);
                console.log("[Auth] Successfully signed in with custom token.");
              } catch (error) {
                try { window.__lastAuthError = { message: error?.message || String(error), code: error?.code || null, stack: error?.stack || null }; } catch(e){ window.__lastAuthError = { message: String(error) }; }
                console.error('[Auth] Custom token sign-in failed:', window.__lastAuthError);
                document.getElementById("login-screen").classList.remove("hidden");
                document.getElementById("app-wrapper").classList.add("hidden");
              }
            } else {
              // No automatic sign-in. Reveal login UI for user to sign in or create an account.
              document.getElementById("login-screen").classList.remove("hidden");
              document.getElementById("app-wrapper").classList.add("hidden");
            }
          }
        });

        // Load settings module (saved views) and render dropdown + settings list (local fallback)
        (function loadSettingsModuleFallback() {
          try {
            import('./js/settings/settings.js').then(mod => {
              // expose module methods to window if they didn't auto-init
              if (typeof mod.initSettingsModule === 'function') mod.initSettingsModule();
              const uid = window.userId || null;
              try { mod.loadSavedViewsFromFirestore(uid).then(() => { if (typeof mod.renderSavedViewsSelect === 'function') mod.renderSavedViewsSelect(); if (typeof mod.renderSettingsSavedViews === 'function') mod.renderSettingsSavedViews(); }).catch(() => { if (typeof mod.renderSavedViewsSelect === 'function') mod.renderSavedViewsSelect(); if (typeof mod.renderSettingsSavedViews === 'function') mod.renderSettingsSavedViews(); }); } catch (e) { console.debug('[Init] render saved views fallback failed', e); }
            }).catch(err => { console.debug('[Init] settings module import failed', err); });
          } catch (e) { console.debug('[Init] settings module load skipped', e); }
        })();

        // --- DATA FUNCTIONS ---

        function setupListeners() {
          console.log(
            "[Function: setupListeners] Setting up Firestore listeners. Find in <script> block."
          );
          if (collectionUnsubscribe) collectionUnsubscribe();
          const collectionRef = collection(db, `artifacts/${appId}/users/${userId}/collection`);
          collectionUnsubscribe = onSnapshot(
            collectionRef,
            (querySnapshot) => {
              let updatedCollection = {};
              querySnapshot.forEach((doc) => {
                updatedCollection[doc.id] = { firestoreId: doc.id, ...doc.data() };
              });
              localCollection = updatedCollection;
              console.log(
                `[Firestore: Collection] Snapshot received. ${
                  Object.keys(localCollection).length
                } cards loaded.`
              );
              updateCardAssignments();
              renderCollection();
              // Re-render deck if visible to update card counts from collection
              const activeDeckId = views.singleDeck.dataset.deckId;
              if (
                !views.singleDeck.classList.contains("hidden") &&
                activeDeckId
              ) {
                renderSingleDeck(activeDeckId);
              }
            },
            (error) => {
              console.error("Error listening to collection changes:", error);
            }
          );

          if (decksUnsubscribe) decksUnsubscribe();
          const decksRef = collection(db, `artifacts/${appId}/users/${userId}/decks`);
          decksUnsubscribe = onSnapshot(
            decksRef,
            (querySnapshot) => {
              let updatedDecks = {};
              querySnapshot.forEach((doc) => {
                updatedDecks[doc.id] = { id: doc.id, ...doc.data() };
              });
              localDecks = updatedDecks;
              console.log(
                `[Firestore: Decks] Snapshot received. ${
                  Object.keys(localDecks).length
                } decks loaded.`
              );
              updateCardAssignments();
              if (!views.decks.classList.contains("hidden")) {
                renderDecksList();
              }
                const activeDeckId = views.singleDeck.dataset.deckId;
              if (
                !views.singleDeck.classList.contains("hidden") &&
                activeDeckId && localDecks[activeDeckId] // Check if deck still exists
              ) {
                renderSingleDeck(activeDeckId);
              } else if (!views.singleDeck.classList.contains("hidden") && !localDecks[activeDeckId]) {
                  // If the currently viewed deck was deleted, switch back to the decks view
                  showToast("The deck you were viewing has been deleted.", "info");
                  showView('decks');
              }
            },
            (error) => {
              console.error("Error listening to deck changes:", error);
            }
          );
        }


        async function saveSettings() {
          // migrated to Public/js/settings/settings.js
          try {
            const mod = await import('./js/settings/settings.js');
            if (typeof mod.saveSettings === 'function') return mod.saveSettings();
          } catch (err) {
            console.debug('settings module not yet available for saveSettings', err);
          }
        }


        async function loadSettings() {
          // migrated to Public/js/settings/settings.js
          try {
            const mod = await import('./js/settings/settings.js');
            if (typeof mod.loadSettings === 'function') return mod.loadSettings();
          } catch (err) {
            console.debug('settings module not yet available for loadSettings', err);
          }
        }

        function updateCardAssignments() {
          // Delegator: prefer the migrated data module's updateCardAssignments
          if (typeof window.updateCardAssignments === 'function' && window.updateCardAssignments !== updateCardAssignments) return window.updateCardAssignments();
          try {
            return import('./js/lib/data.js').then(mod => {
              if (typeof mod.updateCardAssignments === 'function') return mod.updateCardAssignments();
            }).catch(err => console.debug('data module not available for updateCardAssignments', err));
          } catch (err) {
            console.debug('Failed to import data module for updateCardAssignments', err);
          }
        }

        // --- RENDER FUNCTIONS ---

        function renderCollection() {
          // Delegator: prefer the migrated collection module's renderPaginatedCollection
          if (typeof window.renderPaginatedCollection === 'function') return window.renderPaginatedCollection();
          import('./js/pages/collection.js').then(mod => {
            if (typeof mod.renderPaginatedCollection === 'function') mod.renderPaginatedCollection();
          }).catch(err => console.debug('collection module not available for renderCollection', err));
        }

        // groupCardsRecursively migrated to Public/js/pages/collection.js

        // sortCards migrated to Public/js/pages/collection.js

        // sortGroupContent migrated to Public/js/pages/collection.js

        // computeGroupCounts migrated to Public/js/pages/collection.js

        // renderPaginatedCollection migrated to Public/js/pages/collection.js

        // renderPaginationControls migrated to Public/js/pages/collection.js

        // renderCollectionGrid migrated to Public/js/pages/collection.js

    // renderCollectionTable migrated to Public/js/pages/collection.js
        // Robust helper: compute and apply the appropriate top offset for sticky table headers.
        // computeTableHeaderTop migrated to Public/js/pages/collection.js (as computeTableHeaderTop / installFloatingHeaderSync)

        /* Floating header sync and resize/scroll handler migrated to
           Public/js/pages/collection.js (installFloatingHeaderSync). */

        function renderSingleDeck(deckId) {
          console.log(
            `[Function: renderSingleDeck] Rendering view for deck ID ${deckId}. Find in <script> block.`
          );
          const decksMap = window.localDecks || localDecks;
          let deck = decksMap[deckId];
          if (!deck) {
            // Fallback: try to find a deck by scanning values in case the keying differs
            deck = Object.values(decksMap || {}).find(d => d && (d.id === deckId || d.firestoreId === deckId || String(d.id) === String(deckId)));
            if (deck) {
              // Normalize deckId to the deck object's authoritative id
              deckId = deck.id || deck.firestoreId || deckId;
              console.log(`[renderSingleDeck] Fallback matched deck by scanning values. Resolved deckId -> ${deckId}`);
            }
          }

          if (!deck) {
            console.error(
              `[renderSingleDeck] Could not find deck with ID ${deckId}. Available deck keys: ${Object.keys(decksMap || {}).join(', ')}`
            );
            showView("decks");
            return;
          }
          views.singleDeck.dataset.deckId = deckId;
          document.getElementById('page-title').textContent = deck.name;

          const localColl = window.localCollection || localCollection;

          const allDeckCards = Object.keys(deck.cards || {}).map(firestoreId => {
              const cardData = localColl[firestoreId];
              if (!cardData) return null;
              // The count in deck is stored on the deck object
              return { ...cardData, count: deck.cards[firestoreId].count };
          }).filter(Boolean); // Filter out any nulls if card was deleted from collection

          if (deck.commander) {
            // Find the commander in the collection to get its full data, but use a count of 1
            const commanderInCollection = localColl[deck.commander.firestoreId];
            if(commanderInCollection) {
                allDeckCards.push({ ...commanderInCollection, count: 1 });
            }
          }


          // --- Inject Calculated Basic Lands for Stats ---
          // If we have a mana calculator, we can project what basic lands are needed and count them as if they were in the deck.
          if (typeof window.calculateBasicLandNeeds === 'function') {
            try {
              const targetLandCount = 37; // Standard Commander target
              const basicNeeds = window.calculateBasicLandNeeds(deck, targetLandCount);
              const manaColors = { W: 'Plains', U: 'Island', B: 'Swamp', R: 'Mountain', G: 'Forest' };
              
              Object.entries(basicNeeds).forEach(([color, count]) => {
                if (count > 0) {
                  // Create a virtual card entry for the stats
                  allDeckCards.push({
                    name: manaColors[color],
                    type_line: 'Basic Land',
                    cmc: 0,
                    count: count,
                    prices: { usd: 0 }, // Basic lands usually negligible for deck value
                    isVirtual: true // Flag to identify if needed
                  });
                }
              });
            } catch (e) {
              console.warn('[renderSingleDeck] Failed to calculate virtual basic lands for stats', e);
            }
          }

          const totalCost = allDeckCards.reduce((acc, card) => {
            const price =
              card.finish === "foil"
                ? card.prices?.usd_foil
                : card.prices?.usd;
            const cardCost = parseFloat(price) || 0;
            const count = card.count || 1;
            return acc + cardCost * count;
          }, 0);

          // Helper to count cards by type (inclusive check)
          const countByType = (type) => {
             return allDeckCards.reduce((sum, card) => {
               if ((card.type_line || '').includes(type)) return sum + (card.count || 1);
               return sum;
             }, 0);
          };

          const blueprint = deck.aiBlueprint?.suggestedCounts;
          const kpiData = [
            {
              label: "Deck Value",
              current: `$${totalCost.toFixed(2)}`,
              target: null,
            },
            {
              label: "Total",
              current: allDeckCards.reduce((acc, c) => acc + (c.count || 1), 0),
              target: blueprint?.Total,
            },
            {
              label: "Creature",
              current: countByType("Creature"),
              target: blueprint?.Creature,
            },
            {
              label: "Land",
              current: countByType("Land"),
              target: blueprint?.Land,
            },
            {
              label: "Instant",
              current: countByType("Instant"),
              target: blueprint?.Instant,
            },
            {
              label: "Sorcery",
              current: countByType("Sorcery"),
              target: blueprint?.Sorcery,
            },
            {
              label: "Enchantment",
              current: countByType("Enchantment"),
              target: blueprint?.Enchantment,
            },
            {
              label: "Artifact",
              current: countByType("Artifact"),
              target: blueprint?.Artifact,
            },
            {
              label: "Planeswalker",
              current: countByType("Planeswalker"),
              target: blueprint?.Planeswalker,
            },
          ];

          // Add basic lands breakdown if mana calculator is available
          let basicLandsHtml = '';
          try {
            if (typeof window.calculateBasicLandNeeds === 'function') {
              const targetLandCount = 37; // Commander default
              const basicNeeds = window.calculateBasicLandNeeds(deck, targetLandCount);
              const manaColors = { W: 'Plains', U: 'Island', B: 'Swamp', R: 'Mountain', G: 'Forest' };
              const colorSymbols = {
                W: '<img src="https://svgs.scryfall.io/card-symbols/W.svg" class="inline-block w-4 h-4" alt="W">',
                U: '<img src="https://svgs.scryfall.io/card-symbols/U.svg" class="inline-block w-4 h-4" alt="U">',
                B: '<img src="https://svgs.scryfall.io/card-symbols/B.svg" class="inline-block w-4 h-4" alt="B">',
                R: '<img src="https://svgs.scryfall.io/card-symbols/R.svg" class="inline-block w-4 h-4" alt="R">',
                G: '<img src="https://svgs.scryfall.io/card-symbols/G.svg" class="inline-block w-4 h-4" alt="G">'
              };

              const basicLandPills = ['W', 'U', 'B', 'R', 'G']
                .filter(color => basicNeeds[color] > 0)
                .map(color => {
                  const needed = basicNeeds[color];
                  return `<div class="flex items-center gap-1 text-xs bg-gray-800/70 px-2 py-1 rounded">${colorSymbols[color]} ${needed}x ${manaColors[color]}</div>`;
                })
                .join('');

              if (basicLandPills) {
                basicLandsHtml = `
                  <div class="bg-gray-700/50 p-3 rounded-lg mt-2">
                    <div class="text-sm text-gray-400 mb-2">Recommended Basic Lands</div>
                    <div class="flex flex-wrap gap-2">
                      ${basicLandPills}
                    </div>
                  </div>
                `;
              }
            }
          } catch (e) {
            console.debug('[renderSingleDeck] Basic lands calculation failed', e);
          }

          const kpiHtml = kpiData
            .map((kpi) => {
              const hasTarget = kpi.target !== null && kpi.target !== undefined;
              const percentage = hasTarget
                ? Math.min((kpi.current / kpi.target) * 100, 100)
                : 0;
              let barColor = "bg-gray-500";
              if (hasTarget) {
                if (percentage < 50) barColor = "bg-red-500";
                else if (percentage < 90) barColor = "bg-yellow-500";
                else barColor = "bg-green-500";
              }

              return `
                <div class="bg-gray-700/50 p-3 rounded-lg relative overflow-hidden kpi-clickable" data-slot="${kpi.label}" title="Click to ask AI for ${kpi.label} suggestions">
                    <div class="flex justify-between items-baseline">
                        <span class="text-sm text-gray-400">${kpi.label}</span>
                        <span class="font-bold text-lg">${kpi.current}${
                hasTarget ? ` / ${kpi.target}` : ""
              }</span>
                    </div>
                    ${
                      hasTarget
                        ? `<div class="kpi-gradient-bar ${barColor}" style="width: ${percentage}%"></div>`
                        : ""
                    }
                </div>
              `;
            })
            .join("");

          const manaCurveData = allDeckCards.reduce((acc, card) => {
            if (card && !card.type_line.toLowerCase().includes("land")) {
              const cmc = Math.min(card.cmc, 7); // Group 7+ cmc together
              const count = card.count || 1;
              acc[cmc] = (acc[cmc] || 0) + count;
            }
            return acc;
          }, {});

          const colorIdentity = deck.commander?.color_identity || [];
          const colorSymbols = {
            W: '<img src="https://svgs.scryfall.io/card-symbols/W.svg" class="w-5 h-5" alt="White Mana">',
            U: '<img src="https://svgs.scryfall.io/card-symbols/U.svg" class="w-5 h-5" alt="Blue Mana">',
            B: '<img src="https://svgs.scryfall.io/card-symbols/B.svg" class="w-5 h-5" alt="Black Mana">',
            R: '<img src="https://svgs.scryfall.io/card-symbols/R.svg" class="w-5 h-5" alt="Red Mana">',
            G: '<img src="https://svgs.scryfall.io/card-symbols/G.svg" class="w-5 h-5" alt="Green Mana">',
          };
          const colorIcons = colorIdentity
            .map((c) => colorSymbols[c])
            .join("");

          const commanderArt = deck.commander?.image_uris?.art_crop || deck.commander?.image_uris?.normal || '';
          
          views.singleDeck.innerHTML = `
            <div class="space-y-6 animate-fade-in">
                <!-- Banner Header -->
                <div class="relative w-full h-64 bg-gray-900 rounded-xl overflow-hidden shadow-2xl group">
                    <div class="absolute inset-0 bg-cover bg-center transition-transform duration-700 group-hover:scale-105" style="background-image: url('${commanderArt}'); opacity: 0.6;"></div>
                    <div class="absolute inset-0 bg-gradient-to-t from-gray-900 via-gray-900/60 to-transparent"></div>
                    
                    <div class="absolute bottom-0 left-0 p-6 w-full flex flex-col md:flex-row justify-between items-end gap-4">
                        <div>
                            <h2 class="text-4xl font-bold text-white mb-2 drop-shadow-lg tracking-tight">${deck.name}</h2>
                            <div class="flex items-center gap-3 text-gray-300">
                                <span class="bg-indigo-600/80 backdrop-blur-sm px-3 py-1 rounded-full text-xs font-bold uppercase tracking-wider shadow-sm">${deck.format}</span>
                                <div class="flex items-center gap-1 bg-gray-800/60 backdrop-blur-sm px-2 py-1 rounded-full">${colorIcons}</div>
                            </div>
                        </div>
                        <div class="flex items-center gap-3">
                            <button id="add-cards-to-deck-btn" class="bg-green-600 hover:bg-green-500 text-white font-bold py-2 px-6 rounded-lg shadow-lg transition-all transform hover:-translate-y-0.5 flex items-center gap-2">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path></svg>
                                Add Cards
                            </button>
                            <div class="relative group/menu">
                                <button class="bg-gray-700/80 hover:bg-gray-600 text-white p-2 rounded-lg backdrop-blur-sm transition-colors">
                                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 5v.01M12 12v.01M12 19v.01M12 6a1 1 0 110-2 1 1 0 010 2zm0 7a1 1 0 110-2 1 1 0 010 2zm0 7a1 1 0 110-2 1 1 0 010 2z"></path></svg>
                                </button>
                                <div class="absolute right-0 bottom-full mb-2 w-48 bg-gray-800 rounded-lg shadow-xl border border-gray-700 hidden group-hover/menu:block overflow-visible z-10 before:absolute before:-bottom-2 before:left-0 before:w-full before:h-2 before:content-['']">
                                    <button id="deck-delete-btn" data-deck-id="${deckId}" class="w-full text-left px-4 py-3 text-red-400 hover:bg-gray-700 hover:text-red-300 transition-colors flex items-center gap-2 rounded-t-lg">
                                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg>
                                        Delete Deck
                                    </button>
                                    <button id="export-deck-btn" data-deck-id="${deckId}" class="w-full text-left px-4 py-3 text-gray-300 hover:bg-gray-700 hover:text-white transition-colors border-t border-gray-700 rounded-b-lg">
                                        Export List
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Stats Bar -->
                <div class="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-8 gap-3">
                    ${kpiHtml}
                </div>
                
                <!-- Basic Lands Breakdown -->
                ${basicLandsHtml}

                <!-- Main Content Area -->
                <div class="flex flex-col lg:flex-row gap-6">
                    <!-- Left: Decklist (Flexible Width) -->
                    <div class="flex-1 min-w-0 bg-gray-800 rounded-xl shadow-lg p-1">
                        <div class="flex items-center justify-between px-4 py-3 border-b border-gray-700/50">
                            <h3 class="text-lg font-bold text-white">Decklist</h3>
                            <div class="flex bg-gray-900/50 rounded-lg p-1 gap-1">
                                <button id="view-toggle-grid" class="p-1.5 rounded-md text-gray-400 hover:text-white hover:bg-gray-700/50 transition-all" title="Grid View">
                                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2V6zM14 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2V6zM4 16a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2v-2zM14 16a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2v-2z"></path></svg>
                                </button>
                                <button id="view-toggle-table" class="p-1.5 rounded-md text-gray-400 hover:text-white hover:bg-gray-700/50 transition-all" title="Table View">
                                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 10h16M4 14h16M4 18h16"></path></svg>
                                </button>
                            </div>
                        </div>
                        <div id="decklist-container" class="p-4">
                            <!-- Decklist rendered here -->
                        </div>
                    </div>

                    <!-- Right: Tools & Charts (Fixed Width on Desktop) -->
                    <div class="w-full lg:w-80 space-y-6 shrink-0">
                        <!-- Commander Mini-View (if needed, or just keep it in banner) -->
                        ${deck.commander ? `
                        <div class="bg-gray-800 p-4 rounded-xl shadow-lg">
                            <h3 class="text-sm font-bold text-gray-400 uppercase tracking-wider mb-3">Commander</h3>
                            <div class="relative group cursor-pointer" onclick="if(typeof window.renderCardDetailsModal === 'function') window.renderCardDetailsModal(window.localCollection['${deck.commander.firestoreId}'])">
                                <img src="${deck.commander.image_uris?.normal}" class="w-full rounded-lg shadow-md hover:shadow-indigo-500/30 transition-shadow duration-300" alt="${deck.commander.name}">
                            </div>
                        </div>` : ''}

                        <div class="bg-gray-800 p-4 rounded-xl shadow-lg">
                            <h3 class="text-sm font-bold text-gray-400 uppercase tracking-wider mb-3">Mana Curve</h3>
                            <div class="h-32">
                                <canvas id="mana-curve-chart"></canvas>
                            </div>
                        </div>

                        <div class="bg-gray-800 p-4 rounded-xl shadow-lg">
                            <h3 class="text-sm font-bold text-gray-400 uppercase tracking-wider mb-3">AI Tools</h3>
                            <div class="space-y-2">
                                ${deck.aiBlueprint ? `
                                <button id="view-strategy-btn" class="w-full bg-purple-600/20 hover:bg-purple-600/30 text-purple-300 border border-purple-600/50 hover:border-purple-500 font-bold py-2 px-4 rounded-lg transition-all text-sm">View Strategy</button>
                                <button id="rerun-ai-summary-btn" class="w-full bg-yellow-600/20 hover:bg-yellow-600/30 text-yellow-300 border border-yellow-600/50 hover:border-yellow-500 font-bold py-2 px-4 rounded-lg transition-all text-sm">Update Strategy</button>
                                ` : ''}
                                <button id="ai-suggestions-btn" class="w-full bg-indigo-600 hover:bg-indigo-500 text-white font-bold py-2 px-4 rounded-lg shadow-lg transition-all text-sm">
                                    ‚ú® Deck Suggestions
                                </button>
                                <button id="deck-help-btn" class="w-full bg-teal-600/20 hover:bg-teal-600/30 text-teal-300 border border-teal-600/50 hover:border-teal-500 font-bold py-2 px-4 rounded-lg transition-all text-sm">
                                    üí¨ Ask AI Helper
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
          `;

          renderDecklist(deckId);
          renderManaCurveChart(manaCurveData);
          addSingleDeckListeners(deckId);

          // Attach KPI click handlers to ask AI for a single slot/type
          try {
            document.querySelectorAll('.kpi-clickable').forEach(el => {
              el.style.cursor = 'pointer';
              el.addEventListener('click', (e) => {
                const slot = el.dataset.slot;
                if (!slot) return;
                try {
                  import('./js/pages/deckSuggestions.js').then(mod => {
                    if (mod.openDeckSuggestionsModal) mod.openDeckSuggestionsModal(deckId, { type: slot });
                  }).catch(err => console.debug('deckSuggestions module not available for KPI click', err));
                } catch (err) { console.debug('KPI click handler failed', err); }
              });
            });
          } catch (err) { /* ignore attach errors */ }

          // Deck Help button: open a deck-scoped MTG chat helper
          try {
            const helpBtn = document.getElementById('deck-help-btn');
            if (helpBtn) helpBtn.addEventListener('click', () => {
              try { import('./js/pages/deckSuggestions.js').then(mod => { if (mod.openDeckHelp) mod.openDeckHelp(deckId); else if (typeof window.openDeckHelp === 'function') window.openDeckHelp(deckId); }).catch(err => console.debug('deckSuggestions module not available for Deck Help', err)); } catch (e) { console.debug('Deck Help click handler failed', e); }
            });
          } catch (err) { /* ignore */ }

          // Deck Suggestions (full-deck) button
          try {
            const suggestBtn = document.getElementById('ai-suggestions-btn');
            if (suggestBtn) suggestBtn.addEventListener('click', () => {
              try {
                import('./js/pages/deckSuggestions.js').then(mod => {
                  if (mod.openDeckSuggestionsModal) mod.openDeckSuggestionsModal(deckId, { type: null });
                }).catch(err => console.debug('deckSuggestions module not available for full suggestions', err));
              } catch (e) { console.debug('Deck Suggestions click handler failed', e); }
            });
          } catch (e) { /* ignore */ }

          // View AI Strategy button
          try {
            const viewBtn = document.getElementById('view-strategy-btn');
            if (viewBtn) viewBtn.addEventListener('click', () => {
              try {
                import('./js/pages/decks.js').then(mod => {
                  if (mod.renderAiBlueprintModal) mod.renderAiBlueprintModal(deck.aiBlueprint || window.tempAiBlueprint || {}, deck.name);
                  try { openModal('ai-blueprint-modal'); } catch(e){}
                }).catch(err => console.debug('decks module not available for View AI Strategy', err));
              } catch (e) { console.debug('View AI Strategy click failed', e); }
            });
          } catch (e) { /* ignore */ }

          // Rerun AI Summary button: asks Gemini for a new blueprint using the commander + current deck cards
          try {
            const rerunBtn = document.getElementById('rerun-ai-summary-btn');
            if (rerunBtn) rerunBtn.addEventListener('click', async () => {
              try {
                const decksMod = await import('./js/pages/decks.js');
                const blueprint = await (decksMod.getAiDeckBlueprint ? decksMod.getAiDeckBlueprint(deck.commander, allDeckCards) : null);
                window.tempAiBlueprint = blueprint;
                if (decksMod.renderAiBlueprintModal) decksMod.renderAiBlueprintModal(blueprint, deck.name);
                try { openModal('ai-blueprint-modal'); } catch(e){}
              } catch (err) { console.error('Rerun AI summary failed', err); showToast('AI summary failed.', 'error'); }
            });
          } catch (e) { /* ignore */ }
        }

        // --- UI/HELPER FUNCTIONS ---
    function toggleEditMode() {
      if (typeof window.toggleEditMode === 'function' && window.toggleEditMode !== toggleEditMode) return window.toggleEditMode();
      return import('./js/lib/ui.js').then(mod => { if (typeof mod.toggleEditMode === 'function') return mod.toggleEditMode(); }).catch(err => console.debug('ui module not yet available for toggleEditMode', err));
    }

        function toggleCardDetailsEditMode() {
      // Delegate to collection module if available
      if (typeof window.toggleCardDetailsEditMode === 'function' && window.toggleCardDetailsEditMode !== toggleCardDetailsEditMode) return window.toggleCardDetailsEditMode();
      return import('./js/pages/collection.js').then(mod => { if (typeof mod.toggleCardDetailsEditMode === 'function') return mod.toggleCardDetailsEditMode(); }).catch(err => console.debug('collection module not yet available for toggleCardDetailsEditMode', err));
        }

        async function saveCardDetails(firestoreId) {
      if (typeof window.saveCardDetails === 'function' && window.saveCardDetails !== saveCardDetails) return window.saveCardDetails(firestoreId);
      return import('./js/pages/collection.js').then(mod => { if (typeof mod.saveCardDetails === 'function') return mod.saveCardDetails(firestoreId); }).catch(err => console.debug('collection module not yet available for saveCardDetails', err));
        }
        
        function renderCardDetailsModal(card) {
      // Delegate to collection module for rendering details modal
      if (typeof window.renderCardDetailsModal === 'function' && window.renderCardDetailsModal !== renderCardDetailsModal) return window.renderCardDetailsModal(card);
      return import('./js/pages/collection.js').then(mod => { if (typeof mod.renderCardDetailsModal === 'function') return mod.renderCardDetailsModal(card); }).catch(err => console.debug('collection module not yet available for renderCardDetailsModal', err));
        }


    function renderModalVisibilitySettings() {
      // migrated to Public/js/settings/settings.js
      import('./js/settings/settings.js').then(mod => {
      if (typeof mod.renderModalVisibilitySettings === 'function') return mod.renderModalVisibilitySettings();
      }).catch(err => console.debug('settings module not yet available for renderModalVisibilitySettings', err));
    }
        
    // renderAiBlueprintModal migrated to Public/js/pages/decks.js (exported as renderAiBlueprintModal)

        // UI delegators removed: use the shims exported by Public/js/lib/ui.js (which attach window.showToast/openModal/closeModal)
        
        // Delegator to decks module's renderDecksList
        function renderDecksList() {
          if (typeof window.renderDecksList === 'function' && window.renderDecksList !== renderDecksList) return window.renderDecksList();
          try {
            return import('./js/pages/decks.js').then(mod => {
              if (typeof mod.renderDecksList === 'function') return mod.renderDecksList();
              console.debug('decks.renderDecksList not available after import');
            });
          } catch (err) {
            console.debug('Failed to import decks module for renderDecksList', err);
          }
        }
        
        function renderSettings() {
             console.log('[Function: renderSettings] Rendering settings view. Find in <script> block.');
             renderModalVisibilitySettings();
                 // Ensure saved views UI is refreshed when entering the Settings view
                 try { if (typeof window.renderSettingsSavedViews === 'function') window.renderSettingsSavedViews(); } catch(e) { console.debug('[RenderSettings] renderSettingsSavedViews call failed', e); }
                 try { if (typeof window.renderSavedViewsSelect === 'function') window.renderSavedViewsSelect(window.savedViews || []); } catch(e) { console.debug('[RenderSettings] renderSavedViewsSelect call failed', e); }
                 // Playstyle panel is available via header Playstyle button
             const deckListContainer = document.getElementById('settings-deck-list');
             const decks = Object.values(localDecks);
             if (decks.length > 0) {
                 deckListContainer.innerHTML = decks.map(deck => `
                       <div class="flex justify-between items-center bg-gray-700 p-3 rounded-lg">
                           <span>${deck.name}</span>
                           <button class="delete-button bg-red-600 hover:bg-red-700 text-white font-bold py-1 px-3 rounded-lg" data-deck-id="${deck.id}">Delete</button>
                       </div>
                 `).join('');

                 deckListContainer.querySelectorAll('.delete-button').forEach(btn => {
                     btn.addEventListener('click', (e) => {
                         const deckId = e.currentTarget.dataset.deckId;
                         openDeckDeleteOptions(deckId);
                     });
                 });
             } else {
                 deckListContainer.innerHTML = '<p class="text-gray-500">No decks to manage.</p>';
             }
        }

        // Expose delegator functions to window so boot listeners (which may run earlier)
        // can call them even when scripts loaded in different orders.
        try {
          if (typeof window !== 'undefined') {
            window.showView = showView;
            window.renderDecksList = renderDecksList;
            window.renderSettings = renderSettings;
                window.renderSingleDeck = renderSingleDeck;
            window.renderCollection = renderCollection;
            window.searchForCard = searchForCard;
            window.renderCardConfirmationModal = renderCardConfirmationModal;
            window.handleDeckCreationSubmit = handleDeckCreationSubmit;
            window.createDeckFromBlueprint = createDeckFromBlueprint;
          }
        } catch (e) { console.debug('Failed to attach delegators to window', e); }

    // openDeckDeleteOptions migrated to Public/js/pages/decks.js (exported as openDeckDeleteOptions)

        function showView(viewName) {
            console.log(`[Function: showView] Switching to ${viewName} view. Find in <script> block.`);
            Object.keys(views).forEach(key => {
                views[key].classList.add('hidden');
            });
          // Defensive: if the requested view isn't registered, warn and return instead of throwing
          if (!views[viewName]) {
            console.warn('[showView] Unknown view "' + viewName + '" requested. Available views: ' + Object.keys(views).join(', '));
            return;
          }
          views[viewName].classList.remove('hidden');

            Object.keys(navLinks).forEach(key => {
                const link = navLinks[key];
                link.classList.remove('bg-indigo-600', 'text-white');
                link.classList.add('text-gray-400', 'hover:bg-gray-700', 'hover:text-white');
            });
            
            const navLink = navLinks[viewName];
            if (navLink) {
                 navLink.classList.add('bg-indigo-600', 'text-white');
                 navLink.classList.remove('text-gray-400', 'hover:bg-gray-700', 'hover:text-white');
            }

            const pageTitle = document.getElementById('page-title');
            
            if (viewName === 'collection') {
                pageTitle.textContent = 'My Collection';
                 currentSearchContext = { mode: 'collection', deckId: null };
                renderCollection();
                // Ensure any floating collection overlay is constrained/revealed when entering collection view
                try {
                  const overlay = document.getElementById('collection-group-overlay');
                  const contentDiv = document.getElementById('collection-content');
                  if (overlay && contentDiv) {
                    const rect = contentDiv.getBoundingClientRect();
                    overlay.style.left = `${rect.left}px`;
                    overlay.style.width = `${rect.width}px`;
                    overlay.style.right = 'auto';
                    overlay.style.display = overlay.textContent ? 'flex' : 'none';
                  }
                } catch(e) { /* ignore */ }
            } else if (viewName === 'decks') {
                pageTitle.textContent = 'Decks';
                renderDecksList();
            } else if (viewName === 'settings') {
                pageTitle.textContent = 'Settings';
                renderSettings();
            } else if (viewName === 'singleDeck') {
                // Title is set in renderSingleDeck
            }
                // Hide the collection overlay when not viewing collection to avoid phantom text overlaying the sidebar
                try {
                  if (viewName !== 'collection') {
                    const overlay = document.getElementById('collection-group-overlay');
                    if (overlay) overlay.style.display = 'none';
                  }
                } catch (e) { /* ignore */ }

                // Dispatch a custom event so other parts of the app can react to view changes
                try {
                  window.dispatchEvent(new CustomEvent('mtg:viewchange', { detail: { view: viewName } }));
                } catch (e) { /* ignore */ }
        }
        
        function selectCommander(card) {
      // Delegate to migrated collection implementation if present
      if (typeof window.selectCommander === 'function' && window.selectCommander !== selectCommander) return window.selectCommander(card);
      return import('./js/pages/collection.js').then(mod => { if (typeof mod.selectCommander === 'function') return mod.selectCommander(card); }).catch(err => console.debug('collection module not yet available for selectCommander', err));
        }

        function openDeckCreationModal(commanderCard = null) {
            // Delegate to decks module (or collection) for opening deck creation modal
            if (typeof window.openDeckCreationModal === 'function' && window.openDeckCreationModal !== openDeckCreationModal) return window.openDeckCreationModal(commanderCard);
            return import('./js/pages/collection.js').then(mod => { if (typeof mod.openDeckCreationModal === 'function') return mod.openDeckCreationModal(commanderCard); }).catch(err => {
              // fallback to decks module
              return import('./js/pages/decks.js').then(dmod => { if (typeof dmod.openDeckCreationModal === 'function') return dmod.openDeckCreationModal(commanderCard); }).catch(err2 => console.debug('deck/collection modules not yet available for openDeckCreationModal', err, err2));
            });
        }

        function handleCardSelection(card) {
          // Delegate to migrated collection module (or existing window shim)
          if (typeof window.handleCardSelection === 'function' && window.handleCardSelection !== handleCardSelection) return window.handleCardSelection(card);
          return import('./js/pages/collection.js').then(mod => { if (typeof mod.handleCardSelection === 'function') return mod.handleCardSelection(card); }).catch(err => console.debug('collection module not yet available for handleCardSelection', err));
        }

        function renderCardConfirmationModal(card) {
          if (typeof window.renderCardConfirmationModal === 'function' && window.renderCardConfirmationModal !== renderCardConfirmationModal) return window.renderCardConfirmationModal(card);
          return import('./js/pages/collection.js').then(mod => { if (typeof mod.renderCardConfirmationModal === 'function') return mod.renderCardConfirmationModal(card); }).catch(err => console.debug('collection module not yet available for renderCardConfirmationModal', err));
        }
        
        // Delegator to migrated data module's addCardToCollection
        async function addCardToCollection(cardData) {
          // Prefer window shim if available
          if (typeof window.addCardToCollection === 'function' && window.addCardToCollection !== addCardToCollection) return window.addCardToCollection(cardData);
          try {
            const mod = await import('./js/lib/data.js');
            if (typeof mod.addCardToCollection === 'function') {
              const uid = (typeof userId !== 'undefined' && userId) ? userId : (window.userId || null);
              return mod.addCardToCollection(cardData, uid);
            }
          } catch (err) {
            console.debug('data module not yet available for addCardToCollection', err);
          }
        }
        
        // handleAddSelectedCardsToDeck migrated to Public/js/pages/singleDeck.js (exported as handleAddSelectedCardsToDeck)
        
    // getAiDeckBlueprint migrated to Public/js/pages/decks.js (exported as getAiDeckBlueprint)


        function handleDeckCreationSubmit(e) {
          if (typeof window.handleDeckCreationSubmit === 'function' && window.handleDeckCreationSubmit !== handleDeckCreationSubmit) return window.handleDeckCreationSubmit(e);
          try {
            return import('./js/pages/decks.js').then(mod => {
              if (typeof mod.handleDeckCreationSubmit === 'function') return mod.handleDeckCreationSubmit(e);
            }).catch(err => console.debug('decks module not yet available for handleDeckCreationSubmit', err));
          } catch (err) {
            console.debug('Failed to import decks module for handleDeckCreationSubmit', err);
          }
        }
        
    function createDeckFromBlueprint() {
      if (typeof window.createDeckFromBlueprint === 'function' && window.createDeckFromBlueprint !== createDeckFromBlueprint) return window.createDeckFromBlueprint();
      try {
      return import('./js/pages/decks.js').then(mod => {
        if (typeof mod.createDeckFromBlueprint === 'function') return mod.createDeckFromBlueprint();
      }).catch(err => console.debug('decks module not yet available for createDeckFromBlueprint', err));
      } catch (err) {
      console.debug('Failed to import decks module for createDeckFromBlueprint', err);
      }
    }

        // --- AUTHENTICATION FUNCTIONS ---
        async function handleEmailLogin() {
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;
            if (!email || !password) {
                showToast('Please enter both email and password.', 'error');
                return;
            }
      console.log('[Auth] handleEmailLogin start', { email });
      try {
        const res = await signInWithEmailAndPassword(auth, email, password);
        console.log('[Auth] signInWithEmailAndPassword resolved', res);
        // Small deferral to let auth.currentUser populate and for listeners to run
        setTimeout(() => {
          try { console.log('[Auth] post-signin currentUser', auth && auth.currentUser); } catch(e) { console.warn('[Auth] post-signin currentUser check failed', e); }
          try { document.getElementById('login-screen').classList.add('hidden'); document.getElementById('app-wrapper').classList.remove('hidden'); } catch(e){}
          try { if (typeof window.initAppListeners === 'function') window.initAppListeners(); } catch(e){ console.warn('[Auth] initAppListeners call after signin failed', e); }
        }, 150);
      } catch (error) {
        console.error("Error signing in:", error);
        showToast(error.message, 'error');
      }
        }

        async function handleEmailSignup() {
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;
             if (!email || !password) {
                showToast('Please enter both email and password.', 'error');
                return;
            }
      console.log('[Auth] handleEmailSignup start', { email });
      try {
        const res = await createUserWithEmailAndPassword(auth, email, password);
        console.log('[Auth] createUserWithEmailAndPassword resolved', res);
        setTimeout(() => {
          try { console.log('[Auth] post-signup currentUser', auth && auth.currentUser); } catch(e) { console.warn('[Auth] post-signup currentUser check failed', e); }
          try { document.getElementById('login-screen').classList.add('hidden'); document.getElementById('app-wrapper').classList.remove('hidden'); } catch(e){}
          try { if (typeof window.initAppListeners === 'function') window.initAppListeners(); } catch(e){ console.warn('[Auth] initAppListeners call after signup failed', e); }
        }, 150);
      } catch (error) {
        console.error("Error signing up:", error);
        showToast(error.message, 'error');
      }
        }

        async function handleGoogleLogin() {
            const provider = new GoogleAuthProvider();
      console.log('[Auth] handleGoogleLogin start');
      try {
        const res = await signInWithPopup(auth, provider);
        console.log('[Auth] signInWithPopup resolved', res);
        setTimeout(() => {
          try { console.log('[Auth] post-google currentUser', auth && auth.currentUser); } catch(e) { console.warn('[Auth] post-google currentUser check failed', e); }
          try { document.getElementById('login-screen').classList.add('hidden'); document.getElementById('app-wrapper').classList.remove('hidden'); } catch(e){}
          try { if (typeof window.initAppListeners === 'function') window.initAppListeners(); } catch(e){ console.warn('[Auth] initAppListeners call after google signin failed', e); }
        }, 150);
      } catch (error) {
        console.error("Google sign-in error:", error);
        showToast(error.message, 'error');
      }
        }

    // Expose auth handlers for boot wiring and modules that expect window.* functions
    if (typeof window !== 'undefined') {
      window.handleEmailLogin = handleEmailLogin;
      window.handleEmailSignup = handleEmailSignup;
      window.handleGoogleLogin = handleGoogleLogin;
    }

        async function searchForCard(mode, deckId = null) {
          if (typeof window.searchForCard === 'function' && window.searchForCard !== searchForCard) return window.searchForCard(mode, deckId);
          try {
            return import('./js/pages/collection.js').then(mod => { if (typeof mod.searchForCard === 'function') return mod.searchForCard(mode, deckId); }).catch(err => console.debug('collection module not yet available for searchForCard', err));
          } catch (err) {
            console.debug('Failed to import collection module for searchForCard', err);
          }
        }
        
        function searchForCommander() { 
            searchForCard('commander');
        }
        
        function filterCommanderCollectionList() { 
            const filterText = document.getElementById('commander-collection-filter').value.toLowerCase();
            const commanders = document.querySelectorAll('#commander-collection-list > div');
            commanders.forEach(commander => {
                const name = commander.textContent.toLowerCase();
                if (name.includes(filterText)) {
                    commander.style.display = 'flex';
                } else {
                    commander.style.display = 'none';
                }
            });
        }
        
        // Delegators: when forms call these, prefer the module handlers if available.
        function handleAiChat(eOrDeckId) {
          try {
            if (eOrDeckId && eOrDeckId.preventDefault) eOrDeckId.preventDefault();
            // If called as a submit handler, extract the value and deckId if present
            const input = document.getElementById('ai-chat-input');
            const message = input ? input.value : null;
            // Prefer module impl if available
            if (typeof window.__module_handleAiChat === 'function') {
              // If a deckId string/number was passed, forward it; otherwise call with null deckId
              const deckId = (typeof eOrDeckId === 'string' || typeof eOrDeckId === 'number') ? eOrDeckId : null;
              return window.__module_handleAiChat(deckId, message);
            }
            console.warn('handleAiChat module implementation not available.');
          } catch (err) { console.error('handleAiChat delegator error', err); }
        }

        function handleRuleLookup(eOrQuery) {
          try {
            if (eOrQuery && eOrQuery.preventDefault) eOrQuery.preventDefault();
            const input = document.getElementById('rule-lookup-input');
            const query = input ? input.value : (typeof eOrQuery === 'string' ? eOrQuery : null);
            if (typeof window.__module_handleRuleLookup === 'function') return window.__module_handleRuleLookup(query);
            console.warn('handleRuleLookup module implementation not available.');
          } catch (err) { console.error('handleRuleLookup delegator error', err); }
        }

        function handleMtgChat(eOrMessage) {
          try {
            if (eOrMessage && eOrMessage.preventDefault) eOrMessage.preventDefault();
            // Prevent duplicate submissions when multiple listeners (legacy + boot) are attached.
            if (window.__mtgChatRequestInFlight) {
              console.warn('MTG chat request already in-flight; ignoring duplicate submit.');
              return;
            }
            const input = document.getElementById('mtg-chat-input');
            const message = input ? input.value : (typeof eOrMessage === 'string' ? eOrMessage : null);

            if (typeof window.__module_handleMtgChat === 'function') {
              try {
                window.__mtgChatRequestInFlight = true;
                const result = window.__module_handleMtgChat(message);
                // If the module handler returns a promise, clear the flag when done.
                if (result && typeof result.finally === 'function') {
                  result.finally(() => { window.__mtgChatRequestInFlight = false; });
                } else {
                  // synchronous return ‚Äî clear immediately
                  window.__mtgChatRequestInFlight = false;
                }
                return result;
              } catch (innerErr) {
                window.__mtgChatRequestInFlight = false;
                throw innerErr;
              }
            }
            console.warn('handleMtgChat module implementation not available.');
          } catch (err) { console.error('handleMtgChat delegator error', err); }
        }
        
        function confirmClearAllData() {
            console.log("[Function: confirmClearAllData] Opening confirmation modal for clearing all data.");
            document.getElementById('confirmation-title').textContent = 'Delete Everything?';
            document.getElementById('confirmation-message').textContent = 'This will permanently delete your entire collection and all decks. This action is irreversible.';
            openModal('confirmation-modal');
            
            const confirmBtn = document.getElementById('confirm-action-btn');
            // Clone and replace to remove old event listeners
            const newConfirmBtn = confirmBtn.cloneNode(true);
            confirmBtn.parentNode.replaceChild(newConfirmBtn, confirmBtn);

            newConfirmBtn.addEventListener('click', () => {
                closeModal('confirmation-modal');
                executeClearAllData();
            }, { once: true }); // Ensure it only runs once
        }

        async function executeClearAllData() {
            console.log("[Function: executeClearAllData] Executing deletion of all user data.");
            if (!userId) {
                showToast("User not authenticated.", "error");
                return;
            }

            showToast("Deleting all data... This may take a moment.", "warning");

            try {
                const batch = writeBatch(db);
                
                // Get and delete all collection documents
                const collectionRef = collection(db, `artifacts/${appId}/users/${userId}/collection`);
                const collectionSnapshot = await getDocs(collectionRef);
                collectionSnapshot.forEach(doc => batch.delete(doc.ref));

                // Get and delete all deck documents
                const decksRef = collection(db, `artifacts/${appId}/users/${userId}/decks`);
                const decksSnapshot = await getDocs(decksRef);
                decksSnapshot.forEach(doc => batch.delete(doc.ref));

                await batch.commit();

                showToast("All your data has been successfully deleted.", "success");
            } catch (error) {
                console.error("Error clearing all data:", error);
                showToast("An error occurred while deleting your data.", "error");
            }
        }

        // renderCollectionCard now provided by Public/js/pages/collection.js; modules attach legacy shims to window where needed.

    /* addCollectionCardListeners and addCollectionTableListeners migrated to
       Public/js/pages/collection.js (initCollectionModule installs them). */
        
    // Delegator to singleDeck module's renderDecklist
    function renderDecklist(deckId) {
      if (typeof window.renderDecklist === 'function' && window.renderDecklist !== renderDecklist) return window.renderDecklist(deckId);
      try {
      return import('./js/pages/singleDeck.js').then(mod => {
        if (typeof mod.renderDecklist === 'function') return mod.renderDecklist(deckId);
      }).catch(err => console.debug('singleDeck module not yet available for renderDecklist', err));
      } catch (err) {
      console.debug('Failed to import singleDeck module for renderDecklist', err);
      }
    }

    // Delegator to singleDeck module's renderManaCurveChart
    function renderManaCurveChart(manaCurveData) {
      if (typeof window.renderManaCurveChart === 'function' && window.renderManaCurveChart !== renderManaCurveChart) return window.renderManaCurveChart(manaCurveData);
      try {
      return import('./js/pages/singleDeck.js').then(mod => {
        if (typeof mod.renderManaCurveChart === 'function') return mod.renderManaCurveChart(manaCurveData);
      }).catch(err => console.debug('singleDeck module not yet available for renderManaCurveChart', err));
      } catch (err) {
      console.debug('Failed to import singleDeck module for renderManaCurveChart', err);
      }
    }

    // addSingleDeckListeners migrated to Public/js/pages/singleDeck.js (exported as addSingleDeckListeners)

        function renderCardVersions(cards) {
          if (typeof window.renderCardVersions === 'function' && window.renderCardVersions !== renderCardVersions) return window.renderCardVersions(cards);
          return import('./js/pages/collection.js').then(mod => { if (typeof mod.renderCardVersions === 'function') return mod.renderCardVersions(cards); }).catch(err => console.debug('collection module not yet available for renderCardVersions', err));
        }

        // --- UI EVENT LISTENERS ---

        function setupGlobalListeners() {
          console.log(
            "[Function: setupGlobalListeners] Setting up global UI listeners. Find in <script> block."
          );

          // Navigation
          Object.keys(navLinks).forEach((key) => {
            navLinks[key].addEventListener("click", () => {
              if (key === "ruleLookup") {
                openModal("rule-lookup-modal");
              } else if (key === "generalChat") {
                openModal("mtg-chat-modal");
              } else {
                showView(key);
              }
            });
          });

          // Header Buttons
          document
            .getElementById("edit-mode-toggle")
            .addEventListener("click", toggleEditMode);
          document
            .getElementById("new-player-guide-btn")
            .addEventListener("click", () =>
              openModal("new-player-guide-modal")
            );

          // Collection Search & Filters
          document
            .getElementById("search-card-btn")
            .addEventListener("click", () => searchForCard("collection"));
          document
            .getElementById("card-search-input")
            .addEventListener("keyup", (e) => {
              if (e.key === "Enter") searchForCard("collection");
            });

          document
            .getElementById("filter-text")
            .addEventListener("input", () => {
              collectionCurrentPage = 1;
              renderPaginatedCollection();
            });
          document
            .getElementById("collection-group-by-1")
            .addEventListener("change", () => {
              collectionCurrentPage = 1;
              renderPaginatedCollection();
            });
          document
            .getElementById("collection-group-by-2")
            .addEventListener("change", () => {
              collectionCurrentPage = 1;
              renderPaginatedCollection();
            });
          document
            .getElementById("hide-in-deck-checkbox")
            .addEventListener("change", () => {
              collectionCurrentPage = 1;
              renderPaginatedCollection();
            });

          document.querySelectorAll(".grid-size-btn").forEach((btn) => {
            btn.addEventListener("click", () => {
              document
                .querySelectorAll(".grid-size-btn")
                .forEach((b) =>
                  b.classList.remove("bg-indigo-600", "text-white")
                );
              btn.classList.add("bg-indigo-600", "text-white");
              collectionGridSize = btn.dataset.size;
              if (collectionViewMode === "grid") renderPaginatedCollection();
            });
          });

          document.querySelectorAll(".view-toggle").forEach((btn) => {
            btn.addEventListener("click", () => {
              if (btn.id === "view-toggle-grid") {
                collectionViewMode = "grid";
                document
                  .getElementById("view-toggle-table")
                  .classList.remove("bg-indigo-600", "text-white");
                btn.classList.add("bg-indigo-600", "text-white");
              } else {
                collectionViewMode = "table";
                document
                  .getElementById("view-toggle-grid")
                  .classList.remove("bg-indigo-600", "text-white");
                btn.classList.add("bg-indigo-600", "text-white");
              }
              renderPaginatedCollection();
            });
          });

          document
            .getElementById("reset-filters-btn")
            .addEventListener("click", () => {
              console.log("[Event: Click] Reset filters button clicked.");
              document.getElementById("filter-text").value = "";
              document.getElementById("collection-group-by-1").value = "";
              document.getElementById("collection-group-by-2").value = "";
              document.getElementById("hide-in-deck-checkbox").checked = false;
              collectionCurrentPage = 1;
              renderPaginatedCollection();
            });

          // Modals
          document.querySelectorAll(".modal-backdrop").forEach((modal) => {
            modal.addEventListener("click", (e) => {
              if (e.target === modal) {
                closeModal(modal.id);
              }
            });
          });
          document
            .getElementById("close-versions-modal-btn")
            .addEventListener("click", () =>
              closeModal("card-versions-modal")
            );
          document
            .getElementById("close-card-details-btn")
            .addEventListener("click", () => closeModal("card-details-modal"));
          document
            .getElementById("edit-card-details-btn")
            .addEventListener("click", toggleCardDetailsEditMode);

          // Add Cards to Deck Modal Listeners
            document.getElementById('close-add-cards-modal-btn').addEventListener('click', () => closeModal('add-cards-to-deck-modal'));
            document.getElementById('cancel-add-cards-to-deck-btn').addEventListener('click', () => closeModal('add-cards-to-deck-modal'));

          // Deck Creation
          document
            .getElementById("create-deck-btn")
            .addEventListener("click", () => openDeckCreationModal());
          document
            .getElementById("deck-creation-form")
            .addEventListener("submit", handleDeckCreationSubmit);
          document
            .getElementById("cancel-deck-btn")
            .addEventListener("click", () => closeModal("deck-creation-modal"));
          document
            .getElementById("deck-format-select")
            .addEventListener("change", (e) => {
              const container = document.getElementById(
                "commander-selection-container"
              );
              if (e.target.value === "commander") {
                container.classList.remove("hidden");
              } else {
                container.classList.add("hidden");
              }
            });

          document
            .querySelectorAll(".commander-source-btn")
            .forEach((btn) => {
              btn.addEventListener("click", (e) => {
                document
                  .querySelectorAll(".commander-source-btn")
                  .forEach((b) => {
                    b.classList.remove("border-indigo-500", "text-white");
                    b.classList.add("border-transparent", "text-gray-400");
                  });
                e.currentTarget.classList.add("border-indigo-500", "text-white");
                e.currentTarget.classList.remove(
                  "border-transparent",
                  "text-gray-400"
                );

                if (e.currentTarget.id === "commander-source-collection-btn") {
                  document
                    .getElementById("commander-from-collection")
                    .classList.remove("hidden");
                  document
                    .getElementById("commander-from-search")
                    .classList.add("hidden");
                } else {
                  document
                    .getElementById("commander-from-collection")
                    .classList.add("hidden");
                  document
                    .getElementById("commander-from-search")
                    .classList.remove("hidden");
                }
              });
            });

          document
            .getElementById("commander-search-btn")
            .addEventListener("click", searchForCommander);
          document
            .getElementById("commander-search-input")
            .addEventListener("keyup", (e) => {
              if (e.key === "Enter") searchForCommander();
            });
          document
            .getElementById("commander-collection-filter")
            .addEventListener("input", filterCommanderCollectionList);

          // AI Blueprint Modal
          document
            .getElementById("close-blueprint-modal-btn")
            .addEventListener("click", () => closeModal("ai-blueprint-modal"));
          document
            .getElementById("cancel-blueprint-btn")
            .addEventListener("click", () => closeModal("ai-blueprint-modal"));
          document
            .getElementById("confirm-blueprint-btn")
            .addEventListener("click", createDeckFromBlueprint);

          // Run Deck Suggestions directly from the Blueprint modal: create the deck then run suggestions
          try {
            const runBtn = document.getElementById('run-blueprint-suggestions-btn');
            if (runBtn) runBtn.addEventListener('click', async () => {
              try {
                const deckId = await createDeckFromBlueprint();
                if (deckId) {
                  import('./js/pages/deckSuggestions.js').then(mod => {
                    if (mod.openDeckSuggestionsModal) mod.openDeckSuggestionsModal(deckId, { type: null });
                  }).catch(err => console.debug('deckSuggestions module not available after createDeckFromBlueprint', err));
                } else {
                  showToast('Could not create deck to run suggestions.', 'error');
                }
              } catch (err) { console.error('run-blueprint-suggestions failed', err); showToast('Failed to run deck suggestions.', 'error'); }
            });
          } catch (e) { /* ignore */ }

          // AI Chat Modals
          document
            .getElementById("close-ai-modal-btn")
            .addEventListener("click", () => closeModal("ai-suggestions-modal"));
          document
            .getElementById("ai-chat-form")
            .addEventListener("submit", handleAiChat);
          document
            .getElementById("close-rule-lookup-modal-btn")
            .addEventListener("click", () => closeModal("rule-lookup-modal"));
          document
            .getElementById("rule-lookup-form")
            .addEventListener("submit", handleRuleLookup);
          document
            .getElementById("close-mtg-chat-modal-btn")
            .addEventListener("click", () => closeModal("mtg-chat-modal"));
          document
            .getElementById("mtg-chat-form")
            .addEventListener("submit", handleMtgChat);
          document
            .getElementById("close-new-player-guide-modal-btn")
            .addEventListener("click", () =>
              closeModal("new-player-guide-modal")
            );

          // Confirmation Modals
          document
            .getElementById("cancel-action-btn")
            .addEventListener("click", () => closeModal("confirmation-modal"));
          document
            .getElementById("notification-close-btn")
            .addEventListener("click", () => closeModal("notification-modal"));

          document
            .getElementById("cancel-delete-deck-btn")
            .addEventListener("click", () =>
              closeModal("deck-delete-options-modal")
            );
          
          document.getElementById('delete-deck-only-btn').addEventListener('click', (e) => deleteDeck(e.currentTarget.dataset.deckId, false));
          document.getElementById('delete-deck-and-cards-btn').addEventListener('click', (e) => deleteDeck(e.currentTarget.dataset.deckId, true));

          // Settings & Data Management
          document
            .getElementById("logout-btn")
            .addEventListener("click", () => {
              signOut(auth);
              location.reload();
            });
          document
            .getElementById("clear-data-btn")
            .addEventListener("click", confirmClearAllData);
          document.getElementById('export-all-data-btn').addEventListener('click', exportAllData);
          document.getElementById('import-all-data-input').addEventListener('change', handleImportAllData);
          document.getElementById('import-deck-data-input').addEventListener('change', handleImportDeckData);

          // Data Import Modal
          document.getElementById('cancel-import-btn').addEventListener('click', () => closeModal('data-import-options-modal'));
          document.getElementById('import-merge-btn').addEventListener('click', () => processDataImport(false)); // false = merge
          document.getElementById('import-replace-btn').addEventListener('click', () => processDataImport(true)); // true = replace


          // Login
          document
            .getElementById("email-login-btn")
            .addEventListener("click", handleEmailLogin);
          document
            .getElementById("signup-btn")
            .addEventListener("click", handleEmailSignup);
          document
            .getElementById("login-with-google-btn")
            .addEventListener("click", handleGoogleLogin);
        }
        
        /**
         * Checks if a card's color identity is a subset of the commander's color identity.
         * @param {string[]} cardColors - Array of color letters for the card (e.g., ['G', 'W']).
         * @param {string[]} commanderColors - Array of color letters for the commander.
         * @returns {boolean} - True if the card is legal in the deck.
         */
        function isColorIdentityValid(cardColors, commanderColors) {
            if (!cardColors || cardColors.length === 0) {
                return true; // Colorless cards are always valid
            }
            const commanderColorSet = new Set(commanderColors);
            return cardColors.every(color => commanderColorSet.has(color));
        }
        
        // --- ADD CARDS TO DECK MODAL LOGIC ---
    function openAddCardsToDeckModal(deckId) {
      if (typeof window.openAddCardsToDeckModal === 'function' && window.openAddCardsToDeckModal !== openAddCardsToDeckModal) return window.openAddCardsToDeckModal(deckId);
      try {
      return import('./js/pages/singleDeck.js').then(mod => {
        if (typeof mod.openAddCardsToDeckModal === 'function') return mod.openAddCardsToDeckModal(deckId);
      }).catch(err => console.debug('singleDeck module not yet available for openAddCardsToDeckModal', err));
      } catch (err) {
      console.debug('Failed to import singleDeck module for openAddCardsToDeckModal', err);
      }
    }

        // --- DECK DELETION LOGIC ---
    // deleteDeck migrated to Public/js/pages/singleDeck.js (exported as deleteDeck)
        
        // --- DATA EXPORT/IMPORT LOGIC ---
        function exportAllData() {
            try {
                const dataToExport = {
                    collection: localCollection,
                    decks: localDecks,
                    exportedAt: new Date().toISOString()
                };
                const dataStr = JSON.stringify(dataToExport, null, 2);
                const blob = new Blob([dataStr], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `mtg_forge_backup_${new Date().toISOString().split('T')[0]}.json`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
                showToast("Full data exported successfully!", "success");
            } catch (error) {
                console.error("Error exporting data:", error);
                showToast("Failed to export data.", "error");
            }
        }

        function exportDeck(deckId) {
          if (typeof window.exportDeck === 'function' && window.exportDeck !== exportDeck) return window.exportDeck(deckId);
          try {
            return import('./js/pages/singleDeck.js').then(mod => {
              if (typeof mod.exportDeck === 'function') return mod.exportDeck(deckId);
            }).catch(err => console.debug('singleDeck module not yet available for exportDeck', err));
          } catch (err) {
            console.debug('Failed to import singleDeck module for exportDeck', err);
          }
        }

        function handleImportDeckData(event) {
          if (typeof window.handleImportDeckData === 'function' && window.handleImportDeckData !== handleImportDeckData) return window.handleImportDeckData(event);
          try {
            return import('./js/pages/singleDeck.js').then(mod => {
              if (typeof mod.handleImportDeckData === 'function') return mod.handleImportDeckData(event);
            }).catch(err => console.debug('singleDeck module not yet available for handleImportDeckData', err));
          } catch (err) {
            console.debug('Failed to import singleDeck module for handleImportDeckData', err);
          }
        }

        function processDeckImport(deckData) {
          if (typeof window.processDeckImport === 'function' && window.processDeckImport !== processDeckImport) return window.processDeckImport(deckData);
          try {
            return import('./js/pages/singleDeck.js').then(mod => {
              if (typeof mod.processDeckImport === 'function') return mod.processDeckImport(deckData);
            }).catch(err => console.debug('singleDeck module not yet available for processDeckImport', err));
          } catch (err) {
            console.debug('Failed to import singleDeck module for processDeckImport', err);
          }
        }


        function handleImportAllData(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    const data = JSON.parse(e.target.result);
                    if (!data.collection || !data.decks) {
                        throw new Error("Invalid backup file structure.");
                    }
                    tempImportedData = data;
                    openModal('data-import-options-modal');
                } catch(error) {
                    console.error("Error parsing backup file:", error);
                    showToast("Could not parse file. It may be corrupted or not a valid backup.", "error");
                }
            };
            reader.readAsText(file);
            event.target.value = ''; // Reset the input
        }
        
        async function processDataImport(replace) {

      closeModal('data-import-options-modal');
      if (!tempImportedData) {
        showToast("Import data not found.", "error");
        return;
      }

      if (replace) {
        document.getElementById('confirmation-title').textContent = "Replace All Data?";
        document.getElementById('confirmation-message').textContent = "This will permanently delete all your current decks and collection. This action cannot be undone.";
        openModal('confirmation-modal');
        document.getElementById('confirm-action-btn').onclick = async () => {
          closeModal('confirmation-modal');
          await executeDataImportBatched(true);
          document.getElementById('confirm-action-btn').onclick = null;
        };
      } else {
        await executeDataImportBatched(false);
      }
    }

    // Batched import with progress toast
    async function executeDataImportBatched(replace) {
      // Prepare data
      const collectionEntries = Object.entries(tempImportedData.collection || {});
      const deckEntries = Object.entries(tempImportedData.decks || {});
      const total = collectionEntries.length + deckEntries.length;
      let current = 0;
      const batchSize = 400; // Firestore batch limit is 500, use 400 for safety

      // Show persistent toast with progress bar
      let toastId = showToastWithProgress(`Importing data...`, current, total);

      // Optionally delete existing data if replacing
      if (replace) {
        let deleteIds = [
          ...Object.keys(localCollection).map(id => ({ type: 'collection', id })),
          ...Object.keys(localDecks).map(id => ({ type: 'deck', id }))
        ];
        for (let i = 0; i < deleteIds.length; i += batchSize) {
          const batch = writeBatch(db);
          deleteIds.slice(i, i + batchSize).forEach(({ type, id }) => {
            const ref = doc(db, `artifacts/${appId}/users/${userId}/${type === 'collection' ? 'collection' : 'decks'}`, id);
            batch.delete(ref);
          });
          await batch.commit();
        }
      }

      // Helper to batch set/merge
      async function batchWrite(entries, type) {
        for (let i = 0; i < entries.length; i += batchSize) {
          const batch = writeBatch(db);
          entries.slice(i, i + batchSize).forEach(([id, data]) => {
            const ref = doc(db, `artifacts/${appId}/users/${userId}/${type}`, id);
            batch.set(ref, data, { merge: !replace });
          });
          await batch.commit();
          current += Math.min(batchSize, entries.length - i);
          updateToastProgress(toastId, current, total);
        }
      }

      try {
        await batchWrite(collectionEntries, 'collection');
        await batchWrite(deckEntries, 'decks');
        updateToastProgress(toastId, total, total);
        setTimeout(() => removeToastById(toastId), 1500);
        showToast(`Data successfully imported (${replace ? 'Replaced' : 'Merged'}).`, "success");
      } catch (error) {
        console.error("Error executing data import:", error);
        showToast("A problem occurred during the import.", "error");
      } finally {
        tempImportedData = null;
      }
    }

    // Progress toast delegators removed: Public/js/lib/ui.js exposes these helpers and attaches them to window.


        // setupGlobalListeners is now installed by the module boot sequence.
        // (bootApp() calls setupGlobalListeners once to avoid duplicate handlers.)
      });
    </script>
  </body>
</html>
