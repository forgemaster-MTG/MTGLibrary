version: '3.8'

services:
  # --- Staging Application ---
  mtg-library-staging:
    build:
      context: .
      args:
        # these arguments are passed to the build (Vite)
        # You can overwrite these values in your .env file or rely on defaults if strict parity isn't needed
        - VITE_FIREBASE_API_KEY=${VITE_FIREBASE_API_KEY}
        - VITE_FIREBASE_AUTH_DOMAIN=${VITE_FIREBASE_AUTH_DOMAIN}
        - VITE_FIREBASE_PROJECT_ID=${VITE_FIREBASE_PROJECT_ID}
        - VITE_FIREBASE_STORAGE_BUCKET=${VITE_FIREBASE_STORAGE_BUCKET}
        - VITE_FIREBASE_MESSAGING_SENDER_ID=${VITE_FIREBASE_MESSAGING_SENDER_ID}
        - VITE_FIREBASE_APP_ID=${VITE_FIREBASE_APP_ID}
        - VITE_FIREBASE_MEASUREMENT_ID=${VITE_FIREBASE_MEASUREMENT_ID}
    image: mtg-library-staging:latest
    container_name: mtg-library-staging
    restart: always
    ports:
      - "3003:3000" # Host Port 3003
    environment:
      - NODE_ENV=production
      - PORT=3000
      - DATABASE_URL=postgres://admin:Pass4Kincaid!@postgres-staging:5432/mtg_postgres_db_staging
      # PUBLIC_URL controls the redirect URI. Update this to your staging domain.
      - PUBLIC_URL=https://staging.mtg-forge.com
      # Pass runtime env vars as well
      - VITE_FIREBASE_API_KEY=${VITE_FIREBASE_API_KEY}
      - VITE_FIREBASE_AUTH_DOMAIN=${VITE_FIREBASE_AUTH_DOMAIN}
      - VITE_FIREBASE_PROJECT_ID=${VITE_FIREBASE_PROJECT_ID}
      - VITE_FIREBASE_STORAGE_BUCKET=${VITE_FIREBASE_STORAGE_BUCKET}
      - VITE_FIREBASE_MESSAGING_SENDER_ID=${VITE_FIREBASE_MESSAGING_SENDER_ID}
      - VITE_FIREBASE_APP_ID=${VITE_FIREBASE_APP_ID}
      - VITE_FIREBASE_MEASUREMENT_ID=${VITE_FIREBASE_MEASUREMENT_ID}
    volumes:
      - ./serviceAccountKey.json:/app/serviceAccountKey.json
    depends_on:
      - postgres-staging
    networks:
      - staging-network

  # --- Staging Database ---
  postgres-staging:
    image: postgres:latest
    container_name: postgres-staging
    ports:
      - "6469:5432" # Exposed on NAS port 6469
    environment:
      POSTGRES_USER: admin
      POSTGRES_PASSWORD: Pass4Kincaid!
      POSTGRES_DB: mtg_postgres_db_staging
    volumes:
      # Relative path for portability. This creates a folder 'postgres_data_staging' next to this file.
      # Mounting to /var/lib/postgresql helps avoid "directory not empty" errors on NAS (due to @eaDir etc)
      # Postgres will create a 'data' subfolder inside this.
      - ./postgres_data_staging:/var/lib/postgresql
    networks:
      - staging-network
    restart: unless-stopped

  # --- Staging Config for Cloudflare ---
  # You need to generate a NEW Tunnel Token for Staging
  cloudflared-staging:
    image: cloudflare/cloudflared:latest
    container_name: cloudflared-staging
    command: tunnel --no-autoupdate run --token eyJhIjoiMmNhODZkNjRiYTYwNWExNjFiNDBlNGQ2ZGQ3NGFkYWUiLCJ0IjoiYTE2YjIxZWEtN2Y2YS00NTA4LWE2NDQtZTVkYzY3ZjhkM2RkIiwicyI6Ik5HRmtPVEV4T0dNdE1tVTBZeTAwWlRCbExUaGxaV0V0T1RabU1ERmhOVEJqWTJSayJ9
    networks:
      - staging-network
    restart: unless-stopped

networks:
  staging-network:
    name: staging-network
